# Домашняя работа №13 (к занятию от 12.10.23)
[Работа с join'ами и статистикой]

- [x] Использую ранее созданный инстанс виртуальной машины "postgres2" с дефолтными параметрами в YC (ОС:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] Добавлен ssh ключ в metadata ВМ yc_key.pub;
- [x] Развернут кластер БД PostgreSQL 15;

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log`

- [x] Используем демонстрационную базу Перелеты, которая использовалась в предыдущем ДЗ по партиционированию.
⚠️ Демонстрационная база данных взята с edu.postgrespro.ru: demo-big.zip (232 МБ) — данные по полётам за год (размер БД около 2,5 ГБ)
Файлы содержат SQL-скрипт, создающий базу данных demo и наполняющий её данными (фактически, это резервная копия, созданная утилитой pg_dump). Владельцем базы данных demo станет пользователь СУБД, выполнявший скрипт. В кластере `15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log` создана БД **demo**

List of relations

|  Schema  |      Name       | Type  |  Owner   |
|----------|-----------------|-------|----------|
| bookings | aircrafts_data  | table | postgres |
| bookings | airports_data   | table | postgres |
| bookings | boarding_passes | table | postgres |
| bookings | bookings        | table | postgres |
| bookings | flights         | table | postgres |
| bookings | seats           | table | postgres |
| bookings | ticket_flights  | table | postgres |
| bookings | tickets         | table | postgres |
(8 rows)

`demo=# select pg_size_pretty(pg_table_size('flights'));`

| pg_size_pretty | 
|----------------|
| 21 MB          |
(1 row)

`demo=# select pg_size_pretty(pg_table_size('tickets'));`

| pg_size_pretty  | 
|---------------- |
| 386 MB          |
(1 row)

`demo=# select pg_size_pretty(pg_table_size('bookings'));`

| pg_size_pretty| 
|---------------|
| 105 MB        |
(1 row)

- [x] Прежде всего ознакомимся со структурой таблиц **bookings** и **tickets** базы двнных **demo**

`demo=# \d bookings`

Table "bookings.bookings"
|    Column    |           Type           | Collation | Nullable | Default |
|--------------|--------------------------|-----------|----------|---------|
| book_ref     | character(6)             |           | not null |         |
| book_date    | timestamp with time zone |           | not null |         |
| total_amount | numeric(10,2)            |           | not null |         |
|Indexes:     "bookings_pkey" PRIMARY KEY, btree (book_ref)|
|Referenced by:     TABLE "tickets" CONSTRAINT "tickets_book_ref_fkey" FOREIGN KEY (book_ref) REFERENCES bookings(book_ref)|

`demo=# \d tickets`

Table "bookings.tickets"
|     Column     |         Type          | Collation | Nullable | Default |
|----------------|-----------------------|-----------|----------|---------|
| ticket_no      | character(13)         |           | not null |         |
| book_ref       | character(6)          |           | not null |         | 
| passenger_id   | character varying(20) |           | not null |         |
| passenger_name | text                  |           | not null |         |
| contact_data   | jsonb                 |           |          |         |
|Indexes:     "tickets_pkey" PRIMARY KEY, btree (ticket_no)|
|Foreign-key constraints:     "tickets_book_ref_fkey" FOREIGN KEY (book_ref) REFERENCES bookings(book_ref)|
|Referenced by:     TABLE "ticket_flights" CONSTRAINT "ticket_flights_ticket_no_fkey" FOREIGN KEY (ticket_no) REFERENCES tickets(ticket_no)|

demo=# \d boarding_passes

                  Table "bookings.boarding_passes"
   Column    |         Type         | Collation | Nullable | Default 
-------------+----------------------+-----------+----------+---------
 ticket_no   | character(13)        |           | not null | 
 flight_id   | integer              |           | not null | 
 boarding_no | integer              |           | not null | 
 seat_no     | character varying(4) |           | not null | 
Indexes:
    "boarding_passes_pkey" PRIMARY KEY, btree (ticket_no, flight_id)
    "boarding_passes_flight_id_boarding_no_key" UNIQUE CONSTRAINT, btree (flight_id, boarding_no)
    "boarding_passes_flight_id_seat_no_key" UNIQUE CONSTRAINT, btree (flight_id, seat_no)
Foreign-key constraints:
    "boarding_passes_ticket_no_fkey" FOREIGN KEY (ticket_no, flight_id) REFERENCES ticket_flights(ticket_no, flight_id)


---

- [x] Теперь, понимая структуру, используем таблицы **bookings.bookings**, **bookings.tickets** и **bookings.boarding_passes**, реализуем прямое `INNER JOIN` соединение двух или более таблиц. В моём случае соединение 3-х таблиц. Для этого выполним следующие действия:

demo=# SELECT tic.passenger_id,tic.passenger_name, boar.seat_no, book.book_date
FROM tickets AS tic 
INNER JOIN boarding_passes AS boar ON tic.ticket_no=boar.ticket_no
INNER JOIN bookings AS book ON tic.book_ref=book.book_ref
limit 2;

 passenger_id | passenger_name  | seat_no |       book_date        
--------------+-----------------+---------+------------------------
 4246 392925  | KIRILL CHERNOV  | 4A      | 2016-09-13 10:06:00+00
 6027 630039  | ALEKSEY NIKITIN | 23F     | 2016-09-10 22:23:00+00
(2 rows)


