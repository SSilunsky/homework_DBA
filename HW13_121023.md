# –î–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ ‚Ññ13 (–∫ –∑–∞–Ω—è—Ç–∏—é –æ—Ç 12.10.23)
[–†–∞–±–æ—Ç–∞ —Å join'–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π]

- [x] –ò—Å–ø–æ–ª—å–∑—É—é —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã "postgres2" —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ YC (–û–°:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] –î–æ–±–∞–≤–ª–µ–Ω ssh –∫–ª—é—á –≤ metadata –í–ú yc_key.pub;
- [x] –†–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–ª–∞—Å—Ç–µ—Ä –ë–î PostgreSQL 15;

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log`

- [x] –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—É—é –±–∞–∑—É –ü–µ—Ä–µ–ª–µ—Ç—ã, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –î–ó –ø–æ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é.
‚ö†Ô∏è –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∑—è—Ç–∞ —Å edu.postgrespro.ru: demo-big.zip (232 –ú–ë) ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–æ–ª—ë—Ç–∞–º –∑–∞ –≥–æ–¥ (—Ä–∞–∑–º–µ—Ä –ë–î –æ–∫–æ–ª–æ 2,5 –ì–ë)
–§–∞–π–ª—ã —Å–æ–¥–µ—Ä–∂–∞—Ç SQL-—Å–∫—Ä–∏–ø—Ç, —Å–æ–∑–¥–∞—é—â–∏–π –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö demo –∏ –Ω–∞–ø–æ–ª–Ω—è—é—â–∏–π –µ—ë –¥–∞–Ω–Ω—ã–º–∏ (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏, —ç—Ç–æ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è, —Å–æ–∑–¥–∞–Ω–Ω–∞—è —É—Ç–∏–ª–∏—Ç–æ–π pg_dump). –í–ª–∞–¥–µ–ª—å—Ü–µ–º –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö demo —Å—Ç–∞–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–£–ë–î, –≤—ã–ø–æ–ª–Ω—è–≤—à–∏–π —Å–∫—Ä–∏–ø—Ç. –í –∫–ª–∞—Å—Ç–µ—Ä–µ `15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log` —Å–æ–∑–¥–∞–Ω–∞ –ë–î **demo**

List of relations

|  Schema  |      Name       | Type  |  Owner   |
|----------|-----------------|-------|----------|
| bookings | aircrafts_data  | table | postgres |
| bookings | airports_data   | table | postgres |
| bookings | boarding_passes | table | postgres |
| bookings | bookings        | table | postgres |
| bookings | flights         | table | postgres |
| bookings | seats           | table | postgres |
| bookings | ticket_flights  | table | postgres |
| bookings | tickets         | table | postgres |
(8 rows)

`demo=# select pg_size_pretty(pg_table_size('flights'));`

| pg_size_pretty | 
|----------------|
| 21 MB          |
(1 row)

`demo=# select pg_size_pretty(pg_table_size('tickets'));`

| pg_size_pretty  | 
|---------------- |
| 386 MB          |
(1 row)

`demo=# select pg_size_pretty(pg_table_size('bookings'));`

| pg_size_pretty| 
|---------------|
| 105 MB        |
(1 row)

- [x] –ü—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ –æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —Ç–∞–±–ª–∏—Ü **bookings**, **tickets** –∏ **boarding_passes** –±–∞–∑—ã –¥–≤–Ω–Ω—ã—Ö **demo**

`demo=# \d bookings`

Table "bookings.bookings"
|    Column    |           Type           | Collation | Nullable | Default |
|--------------|--------------------------|-----------|----------|---------|
| book_ref     | character(6)             |           | not null |         |
| book_date    | timestamp with time zone |           | not null |         |
| total_amount | numeric(10,2)            |           | not null |         |
|Indexes:     "bookings_pkey" PRIMARY KEY, btree (book_ref)|
|Referenced by:     TABLE "tickets" CONSTRAINT "tickets_book_ref_fkey" FOREIGN KEY (book_ref) REFERENCES bookings(book_ref)|

`demo=# \d tickets`

Table "bookings.tickets"
|     Column     |         Type          | Collation | Nullable | Default |
|----------------|-----------------------|-----------|----------|---------|
| ticket_no      | character(13)         |           | not null |         |
| book_ref       | character(6)          |           | not null |         | 
| passenger_id   | character varying(20) |           | not null |         |
| passenger_name | text                  |           | not null |         |
| contact_data   | jsonb                 |           |          |         |
|Indexes:     "tickets_pkey" PRIMARY KEY, btree (ticket_no)|
|Foreign-key constraints:     "tickets_book_ref_fkey" FOREIGN KEY (book_ref) REFERENCES bookings(book_ref)|
|Referenced by:     TABLE "ticket_flights" CONSTRAINT "ticket_flights_ticket_no_fkey" FOREIGN KEY (ticket_no) REFERENCES tickets(ticket_no)|

`demo=# \d boarding_passes`

 Table "bookings.boarding_passes"
|   Column    |         Type         | Collation | Nullable | Default |
|-------------|----------------------|-----------|----------|---------|
| ticket_no   | character(13)        |           | not null |         |
| flight_id   | integer              |           | not null |         |
| boarding_no | integer              |           | not null |         |
| seat_no     | character varying(4) |           | not null |         |

Indexes:

"boarding_passes_pkey" PRIMARY KEY, btree (ticket_no, flight_id)

"boarding_passes_flight_id_boarding_no_key" UNIQUE CONSTRAINT, btree (flight_id, boarding_no)

"boarding_passes_flight_id_seat_no_key" UNIQUE CONSTRAINT, btree (flight_id, seat_no)

Foreign-key constraints:

"boarding_passes_ticket_no_fkey" FOREIGN KEY (ticket_no, flight_id) REFERENCES ticket_flights(ticket_no, flight_id)

---

- [x] –¢–µ–ø–µ—Ä—å, –ø–æ–Ω–∏–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–±–ª–∏—Ü—ã **bookings.bookings**, **bookings.tickets** –∏ **bookings.boarding_passes**, —Ä–µ–∞–ª–∏–∑—É–µ–º –ø—Ä—è–º–æ–µ `INNER JOIN` —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –∏–ª–∏ –±–æ–ª–µ–µ —Ç–∞–±–ª–∏—Ü. –í –º–æ—ë–º —Å–ª—É—á–∞–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 3-—Ö —Ç–∞–±–ª–∏—Ü. –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏–º —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

`demo=# SELECT tic.passenger_id,tic.passenger_name, boar.seat_no, book.book_date`

`FROM tickets AS tic`

`INNER JOIN boarding_passes AS boar ON tic.ticket_no=boar.ticket_no`

`INNER JOIN bookings AS book ON tic.book_ref=book.book_ref`

`limit 2;`

| passenger_id | passenger_name  | seat_no |       book_date        |
|--------------|-----------------|---------|------------------------|
| 4246 392925  | KIRILL CHERNOV  | 4A      | 2016-09-13 10:06:00+00 |
| 6027 630039  | ALEKSEY NIKITIN | 23F     | 2016-09-10 22:23:00+00 |
(2 rows)

üòÑ –ó–∞–ø—Ä–æ—Å —Å–æ–µ–¥–∏–Ω—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É –±–∏–ª–µ—Ç–æ–≤(tickets) —Å —Ç–∞–±–ª–∏—Ü–µ–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π(bookings) –∏ —Å —Ç–∞–±–ª–∏—Ü–µ–π –ø–æ—Å—Å–∞–∂–∏—Ä–æ–≤ –Ω–∞ –±–æ—Ä—Ç—É —Å–∞–º–æ–ª–µ—Ç–∞(boarding_passes): –º—ã –ø–æ–ª—É—á–∏–ª–∏ –≤ –≤—ã–≤–æ–¥–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ 3-—Ö —Ç–∞–±–ª–∏—Ü –æ —Ç–æ–º, –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –≤ —Å–∞–º–æ–ª–µ—Ç–µ.

---

- [x] –î–∞–ª–µ–µ, —Ä–µ–∞–ª–∏–∑—É–µ–º –ª–µ–≤–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ `LEFT JOIN` —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –∏–ª–∏ –±–æ–ª–µ–µ —Ç–∞–±–ª–∏—Ü. –í –º–æ—ë–º —Å–ª—É—á–∞–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 3-—Ö —Ç–∞–±–ª–∏—Ü. –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏–º —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

`demo=# SELECT tic.passenger_id,tic.passenger_name, boar.seat_no, book.book_date`

`FROM tickets AS tic `

`LEFT JOIN boarding_passes AS boar ON tic.ticket_no=boar.ticket_no`

`LEFT JOIN bookings AS book ON tic.book_ref=book.book_ref`

`limit 3;`

| passenger_id | passenger_name  | seat_no |       book_date         |
|--------------|-----------------|---------|------------------------ |
| 4030 855525  | MIKHAIL SEMENOV | 10C     | 2016-08-01 05:07:00+00  |
| 8360 311602  | ELENA ZAKHAROVA | 2A      | 2016-08-05 08:05:00+00  |
| 4510 377533  | ILYA PAVLOV     | 10E     | 2016-07-30 12:20:00+00  |
(3 rows)

üòÑ –ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤ –≤—ã–≤–æ–¥–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ 3-—Ö —Ç–∞–±–ª–∏—Ü –æ —Ç–æ–º, –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –≤ —Å–∞–º–æ–ª–µ—Ç–µ. –£—Å–ª–æ–≤–∏–µ `LEFT JOIN` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ –ª–µ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã (tickets), –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏ –≤ –ø—Ä–∞–≤–æ–π(–ø—Ä–∞–≤—ã—Ö) —Ç–∞–±–ª–∏—Ü–µ (boarding_passes –∏ bookings), –¥–∞–∂–µ –µ—Å–ª–∏ –≤ –ø—Ä–∞–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ (boarding_passes –∏ bookings) –Ω–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—Ä–æ–∫.

---

- [x] –î–∞–ª–µ–µ, —Ä–µ–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–Ω–æ–µ `CROSS JOIN` —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –∏–ª–∏ –±–æ–ª–µ–µ —Ç–∞–±–ª–∏—Ü. –í –º–æ—ë–º —Å–ª—É—á–∞–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 2-—Ö —Ç–∞–±–ª–∏—Ü **tickets** –∏ **boarding_passes**. –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏–º —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:


`demo=# SELECT t.passenger_name, b.seat_no`

`FROM tickets as t, boarding_passes as b`

`CROSS JOIN boarding_passes`

`limit 2;`

| passenger_name | seat_no | 
|----------------|---------|
| ARTEM EGOROV   | 11E     |
| ARTEM EGOROV   | 11E     |
(2 rows)

üòÑ –£—Å–ª–æ–≤–∏–µ `CROSS JOIN` –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–µ–∫–∞—Ä—Ç–æ–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ –¥–≤—É—Ö –∏–ª–∏ –±–æ–ª–µ–µ —Ç–∞–±–ª–∏—Ü–∞—Ö. 

---

- [x] –î–∞–ª–µ–µ, —Ä–µ–∞–ª–∏–∑—É–µ–º –ø–æ–ª–Ω–æ–µ `FULL JOIN` —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –∏–ª–∏ –±–æ–ª–µ–µ —Ç–∞–±–ª–∏—Ü. –í –º–æ—ë–º —Å–ª—É—á–∞–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 2-—Ö —Ç–∞–±–ª–∏—Ü **tickets** –∏ **boarding_passes**. –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏–º —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

`demo=# SELECT t.passenger_id, b.flight_id`

`FROM tickets AS t`

`FULL JOIN boarding_passes AS b ON t.ticket_no=b.ticket_no`

`limit 3;`

| passenger_id | flight_id |
|--------------|-----------|
| 4030 855525  |    187662 |
| 8360 311602  |    187570 |
| 4510 377533  |    187570 |
(3 rows)

üòÑ `FULL JOIN` –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ª–µ–≤–æ–≥–æ –∏ –ø—Ä–∞–≤–æ–≥–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–π. –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ –≤ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç, –ø–æ–ª–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è `NULL` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ —Ç–∞–±–ª–∏—Ü—ã, –≤ –∫–æ—Ç–æ—Ä–æ–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–≤–ø–∞–¥–∞—é—â–∞—è —Å—Ç—Ä–æ–∫–∞. –î–ª—è —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Å—Ç—Ä–æ–∫ –≤ —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏–π –Ω–∞–±–æ—Ä –≤–∫–ª—é—á–∞–µ—Ç—Å—è –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–æ–ª–±—Ü—ã, –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –æ–±–µ–∏—Ö –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü.

---
- [x] –î–∞–ª–µ–µ, —Ä–µ–∞–ª–∏–∑—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π. –í –º–æ—ë–º —Å–ª—É—á–∞–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 3-—Ö —Ç–∞–±–ª–∏—Ü **bookings**, **tickets** –∏ **boarding_passes**. –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏–º —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

`demo=# SELECT tic.passenger_id,tic.passenger_name, boar.seat_no, book.book_date`

`FROM tickets AS tic`

`CROSS JOIN boarding_passes`

`INNER JOIN boarding_passes AS boar ON tic.ticket_no=boar.ticket_no`

`LEFT JOIN bookings AS book ON tic.book_ref=book.book_ref`

`limit 2;`

| passenger_id | passenger_name | seat_no |       book_date        | 
|--------------|----------------|---------|------------------------|
| 3501 736642  | ARTEM EGOROV   | 3A      | 2016-11-09 10:46:00+00 |
| 3501 736642  | ARTEM EGOROV   | 3A      | 2016-11-09 10:46:00+00 |
(2 rows)

---
## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ

- [x] –ü–æ—Å–º–æ—Ç—Ä–∏–º –º–µ—Ç—Ä–∏–∫–∏ –ë–î **demo** –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ **pg_stat_database**:

`demo=# select datname, numbackends, xact_commit, xact_rollback, blks_read, blks_hit, tup_returned, tup_fetched, tup_inserted, tup_updated, tup_deleted, stats_reset`

`from pg_stat_database`

`where datname = 'demo';`

| datname | numbackends | xact_commit | xact_rollback | blks_read | blks_hit | tup_returned | tup_fetched | tup_inserted | tup_updated | tup_deleted | stats_reset |
|---------|-------------|-------------|---------------|-----------|----------|--------------|-------------|--------------|-------------|-------------|-------------|
| demo    |           0 |        1823 |            83 |   1217198 | 37576983 |    119810388 |     2729016 |     23707709 |         119 |         222 |             |
(1 row)

- –ü–æ—Å–º–æ—Ç—Ä–∏–º –º–µ—Ç—Ä–∏–∫–∏ —Ç–∞–±–ª–∏—Ü—ã **tickets**, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ **pg_class**:
  
`demo=# select * from pg_class where relname = 'tickets'; \gx`

| RECORD 1           |             |
|--------------------|-------------|
|oid                 | 16763 |      
|relname             | tickets|
|relnamespace        | 16709|
|reltype             | 16765|
|reloftype           | 0|
|relowner            | 10|
|relam               | 2|
|relfilenode         | 16763|
|reltablespace       | 0|
|relpages            | 49415|
|reltuples           | 2.949857e+06|
|relallvisible       | 49415|
|reltoastrelid       | 16766|
|relhasindex         | t|
|relisshared         | f|
|relpersistence      | p|
|relkind             | r|
|relnatts            | 5|
|relchecks           | 0|
|relhasrules         | f|
|relhastriggers      | t|
|relhassubclass      | f|
|relrowsecurity      | f|
|relforcerowsecurity | f|
|relispopulated      | t|
|relreplident        | d|
|relispartition      | f|
|relrewrite          | 0|
|relfrozenxid        | 1212720|
|relminmxid          | 1|
|relacl              |  |
|reloptions          |  |
|relpartbound        |  |



