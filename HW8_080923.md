# Домашняя работа №8 (к занятию от 08.09.23)
[Нагрузочное тестирование и тюнинг PostgreSQL]

- [x] Использую ранее созданный инстанс виртуальной машины "postgres2" с дефолтными параметрами в YC (ОС:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] Добавлен ssh ключ в metadata ВМ yc_key.pub;
- [x] Развернут кластер БД PostgreSQL 15;

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log`

- [x] Настроим кластер PostgreSQL 15 на максимальную производительность не обращая внимание на возможные проблемы с надежностью в случае аварийной перезагрузки виртуальной машины.

| РЕСУРСЫ ВИРТУАЛЬНОЙ МАШИНЫ YC|                |
|------------------------------|----------------|
| Платформа                    | Intel Ice Lake |
| Гарантированная доля vCPU    | 50%            |
| vCPU                         | 2              |
| RAM                          | 4 ГБ           |
| Объём дискового пространства | 21 ГБ          |

`postgres@postgres2:~$ psql`

psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1))

Type "help" for help.

`postgres=# show config_file;`

| config_file                              |               
|----------------------------------------- |
| /etc/postgresql/15/main/postgresql.conf  |
(1 row)

`postgres@postgres2:~$ free`

| type      | total     | used        | free        | shared      | buff/cache  | available  |
|-----------|-----------|-------------|-------------|-------------|-------------|------------|
| Mem:      | 4004912   |      199780 |    3379852  |     28240   |   425280    | 3544160    |


`postgres@postgres2:~$ df -h`

| Filesystem     | Size | Used | Avail | Use% | Mounted on |
|----------------|------|------|-------|------|------------|
| /dev/vda2      | 9.8G | 4.7G | 4.7G  | 51%  | /          |
| /dev/vdb       |  11G | 694M | 9.5G  | 7%   | /mnt       |

- Для тюнинга производительности Кластера воспользуемся рекомендациями с сайта https://pgtune.leopard.in.ua

![tune1](https://github.com/SSilunsky/homework_DBA/blob/main/tune.png)

![tune2](https://github.com/SSilunsky/homework_DBA/blob/main/tune2.png)

- В соответствии с рекомендациями PGТюнера, вносим правки с помощью `ALTER SYSTEM SET`:

`postgres=# ALTER SYSTEM SET  max_connections = '600';`

`ALTER SYSTEM SET  shared_buffers = '1GB';`

`ALTER SYSTEM SET  effective_cache_size = '3GB';`

`ALTER SYSTEM SET  maintenance_work_mem = '256MB';`

`ALTER SYSTEM SET  checkpoint_completion_target = '0.9';`

`ALTER SYSTEM SET  wal_buffers = '16MB';`

`ALTER SYSTEM SET  default_statistics_target = '100';`

`ALTER SYSTEM SET  random_page_cost = '1.1';`

`ALTER SYSTEM SET  effective_io_concurrency = '200';`

`ALTER SYSTEM SET  work_mem = '873kB';`

`ALTER SYSTEM SET  huge_pages = 'off';`

`ALTER SYSTEM SET  min_wal_size = '2GB';`

`ALTER SYSTEM SET  max_wal_size = '8GB';`

Далее перезакгужаем конфигурацию и Кластер БД, чтобы применились вннесенные изменения:

postgres=# select pg_reload_conf();
 pg_reload_conf 
----------------
 t
(1 row)

postgres@postgres2:~$ pg_ctlcluster 15 main stop
Warning: stopping the cluster using pg_ctlcluster will mark the systemd unit as failed. Consider using systemctl:
  sudo systemctl stop postgresql@15-main
postgres@postgres2:~$ pg_lsclusters 
Ver Cluster Port Status Owner    Data directory              Log file
14  main    5433 online postgres /var/lib/postgresql/14/main /var/log/postgresql/postgresql-14-main.log
15  main    5432 down   postgres /mnt/data/15/main           /var/log/postgresql/postgresql-15-main.log
postgres@postgres2:~$ pg_ctlcluster 15 main start
Warning: the cluster will not be running as a systemd service. Consider using systemctl:
  sudo systemctl start postgresql@15-main
postgres@postgres2:~$ pg_lsclusters 
Ver Cluster Port Status Owner    Data directory              Log file
14  main    5433 online postgres /var/lib/postgresql/14/main /var/log/postgresql/postgresql-14-main.log
15  main    5432 online postgres /mnt/data/15/main           /var/log/postgresql/postgresql-15-main.log
postgres@postgres2:~$ 

- Проверим, что внесенные в autoconf изменения применились:

postgres=# show max_connections;
 max_connections 
-----------------
 600
(1 row)

postgres=# show work_mem;
 work_mem 
----------
 873kB
(1 row)



