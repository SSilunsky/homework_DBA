# Домашняя работа №3 (к занятию от 21.08.23)

- [x] Cоздан инстанс виртуальной машины "postgres" с дефолтными параметрами в YC (ОС:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] Добавлен ssh ключ в metadata ВМ yc_key.pub
- [x] Развернут кластер БД PostgreSQL 15

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log`

- [x] Создана База данных `silunsky_db`

postgres=# \l

                                                  List of databases
      
|   Name      |  Owner   | Encoding |   Collate   |    Ctype    | ICU Locale | Locale Provider |   Access privileges   |
|-------------|----------|----------|-------------|-------------|------------|-----------------|-----------------------|
| postgres    | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            |                       |
| **silunsky_db** | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            |                       |
 
---
 
- [x] Создана таблица "**otus**"

silunsky_db=# \dt

        List of relations    
| Schema | Name | Type  |  Owner  |  
|--------|------|-------|---------|
| public | **otus** | table | postgres|
 
(1 row)

---

- [x] Таблица заполнина данными.

`silunsky_db=# SELECT * FROM otus;`

| i | amount | 
|---|--------|
| 1 |    100 |
| 2 |    200 |
| 3 |    300 |
| 4 |    500 | 

(4 rows)

---

- [x] В YC создан новый диск "**disk2**"(/dev/vdb) объемом 11 ГБ, подключен к ВМ "**postgres**", диск отформатирован и примонтирован к директории **/mnt/disk2**

silunsky@postgres:~$ lsblk -f

NAME   FSTYPE   FSVER LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINTS

vda                                                                             
├─vda1                                                                          
└─vda2 ext4     1.0         ed465c6e-049a-41c6-8e0b-c8da348a3577    4.1G    53% /
vdb    ext4     1.0         224c5efb-4cfd-41c2-af26-2c2af04a45d8   10.2G     0% /mnt/disk2

- [x] В директории **/mnt/disk2** создана директория **/mnt/disk2/data** с дискреционными правами доступа для пользователя "postgres"

`silunsky@postgres:/mnt/disk2$ ls -l`

`total 20`

`drwxrwxr-x 2 postgres postgres  4096 Aug 22 07:58 data`

---
- [x] Остановлен Кластер БД

`silunsky@postgres:~$ sudo -u postgres pg_ctlcluster 15 main stop`

`silunsky@postgres:~$ pg_lsclusters `

`Ver Cluster Port Status Owner    Data directory              Log file`

`15  main    5432 down   postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log`

- [x] Перенесено содержимое директории **/var/lib/postgresql/15/** в директорию **/mnt/disk2/data/**

`postgres@postgres:~$ ls -l /mnt/disk2/data/`

`drwxr-xr-x 3 postgres postgres 4096 Aug 21 06:19 15` 

- [x] Осуществлена попыпка запуска Кластера БД.
      
Получаем следующее сообщение:

`postgres@postgres:/home/silunsky$ pg_ctlcluster 15 main start`

`Error: /var/lib/postgresql/15/main is not accessible or does not exist`

Для исправления данного поведения требуется внести корректировки в конфигурационный файл: `/etc/postgresql/15/main/postgresql.conf`
а именно:
- найти строку с параметром `data_directory = '/var/lib/postgresql/15/main'`
- указать директорию на подключенном диске, приведя строку с параметром к следующему виду:
  
`data_directory = '/mnt/disk2/data/15/main'              # use data in another directory`

- сохранить внесенные изменения;
- запустить кластер БД, выполнив команду:

  `silunsky@postgres:~$ sudo -u postgres pg_ctlcluster 15 main start`
  
- проверить статус Кластера БД, командой:
  
`postgres@postgres:/home/silunsky$ pg_ctlcluster 15 main status`

`pg_ctl: server is running (PID: 1305)`

Проверяем доступность кластера БД в новой директории **/mnt/disk2/data/**, выполнив команду:

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory          Log file`

`15  main    5432 online postgres /mnt/disk2/data/15/main /var/log/postgresql/postgresql-15-main.log`

    
