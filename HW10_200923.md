# –î–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ ‚Ññ10 (–∫ –∑–∞–Ω—è—Ç–∏—é –æ—Ç 20.09.23)
[–í–∏–¥—ã –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –≤ PostgreSQL. –ü—Ä–∞–∫—Ç–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è ]

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ú–∞—à–∏–Ω(–í–ú)

- [x] –ò—Å–ø–æ–ª—å–∑—É—é —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã "postgres3" —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ YC (–û–°:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] –î–æ–±–∞–≤–ª–µ–Ω ssh –∫–ª—é—á –≤ metadata –í–ú yc_key.pub;
- [x] –†–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–ª–∞—Å—Ç–µ—Ä –ë–î PostgreSQL 16;
- [x] –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤ YC —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã –∏–Ω—Å—Ç–∞–Ω—Å—ã –ú–í "postgres4", "postgres5", "postgres6" —Å –∫–æ–Ω—Ñ–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –Ω–∞–ø–∞–º–µ—Ç—Ä–∞–º–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏ –í–ú "postgres"

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 4 –í–ú –≤ –ø–æ–¥—Å–µ—Ç–∏ sil-net-public
| –ù–∞–∑–≤–∞–Ω–∏–µ –í–ú | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π IPv4 |
|-------------|-----------------|
| postgres3   | 192.168.0.13    |
| postgres4   | 192.168.0.12    |
| postgres5   | 192.168.0.6     |
| postgres6   | 192.168.0.9     |

- –î–ª—è –≤–∑–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –í–ú –º–µ–∂–¥—É —Å–æ–±–æ–π –≤–Ω–æ—Å–∏–º –ø—Ä–∞–≤–∫–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª `/etc/postgresql/16/main/postgresql.conf` –Ω–∞ –∫–∞–∂–¥–æ–π –í–ú:
`listen_addresses = '*'                  # what IP address(es) to listen on;`

- –¢–∞–∫–∂–µ –≤–Ω–æ—Å–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è  –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª `/etc/postgresql/16/main/pg_hba.conf` –Ω–∞ –∫–∞–∂–¥–æ–π –í–ú:

`# IPv4 local connections:`

`host    all             all             192.168.0.0/24          scram-sha-256`

`# replication privilege.`

`host    replication     all             192.168.0.0/24          scram-sha-256`

---

- [x] –ù–∞ –í–ú **postgres3** —Ç–∞–±–ª–∏—Ü—ã: **test** –¥–ª—è –∑–∞–ø–∏—Å–∏, **test2** –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ.
- –Ω–∞ –≤—Å–µ—Ö –í–ú —Å–æ–∑–¥–∞–¥–∏–º –ë–î **silunsky_repl** –∏ —Ç–∞–±–ª–∏—Ü—ã **test** –∏ **test2**

`postgres@postgres4:~$ psql `

`psql (16.0 (Ubuntu 16.0-1.pgdg22.04+1))`

`postgres=# create database silunsky_repl;`

CREATE DATABASE

`postgres=# create table test (i int);`

CREATE TABLE

`postgres=# create table test2 (i int);`

CREATE TABLE

`postgres=# \dt`

List of relations
| Schema | Name  | Type  |  Owner  |   
|--------|-------|-------|---------|
| public | test  | table | postgres|
| public | test2 | table | postgres|
(2 rows)

---

- [x] –°–æ–∑–¥–∞–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Ç–∞–±–ª–∏—Ü—ã **test** –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Ç–∞–±–ª–∏—Ü—ã **test2** —Å –í–ú **postgres4**:
- –ø—Ä–æ–≤–µ—Ä–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–µ—Ä–≤–µ—Ä–∞ wal_level –Ω–∞ –í–ú **postgres3** –∏ **postgres3** –∏ —É—Å—Ç–∞–Ω–æ–≤–∏–º –≤ –∑–∞–Ω—á–µ–Ω–∏–µ `logical`:

`postgres=# show wal_level;`

| wal_level | 
|-----------|
| replica   |
(1 row)

`postgres=# alter system set wal_level = logical;`

ALTER SYSTEM

- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ö–ª–∞—Å—Ç–µ—Ä –ë–î, –ø–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `wal_level`:

`postgres@postgres3:~$ pg_ctlcluster 16 main stop`

`postgres@postgres3:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`16  main    5432 down   postgres /var/lib/postgresql/16/main /var/log/postgresql/postgresql-16-main.log`

`postgres@postgres3:~$ pg_ctlcluster 16 main start`

`postgres@postgres3:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`16  main    5432 online postgres /var/lib/postgresql/16/main /var/log/postgresql/postgresql-16-main.log`

`postgres@postgres3:~$ psql`

`psql (16.0 (Ubuntu 16.0-1.pgdg22.04+1))`

`postgres=# show wal_level;`

| wal_level | 
|-----------|
| logical   |
(1 row)

- –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –Ω–∞ –í–ú **postgres4**

`postgres@postgres4:~$ psql`

`psql (16.0 (Ubuntu 16.0-1.pgdg22.04+1))`

`postgres=# show wal_level;`

| wal_level | 
|-----------|
| logical   |
(1 row)

- –ù–∞ –í–ú **postgres3** —Å–æ–∑–¥–∞–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Ç–∞–±–ª–∏—Ü—ã **test**:

`postgres=# CREATE PUBLICATION test_pub FOR TABLE test;`

CREATE PUBLICATION

- –ü—Ä–æ–≤–µ—Ä–∏–º —Å–æ–∑–¥–∞–Ω–Ω—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é:

`postgres=# \dRp+`

Publication test_pub
| Owner   | All tables | Inserts | Updates | Deletes | Truncates | Via root |
|---------|------------|---------|---------|---------|-----------|----------|
|postgres | f          | t       | t       | t       | t         | f        |

Tables:

"public.test"

- [x] –°–æ–∑–¥–∞–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Ç–∞–±–ª–∏—Ü—ã **test2** –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Ç–∞–±–ª–∏—Ü—ã **test** —Å –í–ú **postgres3**.
- –ù–∞ –í–ú **postgres4** —Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã test2 –¥–ª—è –∑–∞–ø–∏—Å–∏, test –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ.

`postgres=# \dt`

List of relations
| Schema | Name  | Type  |  Owner  |   
|--------|-------|-------|---------|
| public | test  | table | postgres|
| public | test2 | table | postgres|
(2 rows)

---

- –ù–∞ –í–ú **postgres4** —Å–æ–∑–¥–∞–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Ç–∞–±–ª–∏—Ü—ã **test2**:

`postgres=# CREATE PUBLICATION test_pub FOR TABLE test2;`

CREATE PUBLICATION

- –ü—Ä–æ–≤–µ—Ä–∏–º —Å–æ–∑–¥–∞–Ω–Ω—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é:

`postgres=# \dRp+`

Publication test_pub
| Owner   | All tables | Inserts | Updates | Deletes | Truncates | Via root |
|---------|------------|---------|---------|---------|-----------|----------|
|postgres | f          | t       | t       | t       | t         | f        |

Tables:

"public.test2"

---

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ –í–ú

- –ù–∞ –í–ú **postgres3** –Ω–∞—Å—Ç—Ä–æ–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –í–ú **postgres4**

`silunsky_repl=# CREATE SUBSCRIPTION test_sub_vm4 `

`CONNECTION 'host=192.168.0.12 port=5432 user=postgres password=1 dbname=silunsky_repl' `

`PUBLICATION test_pub WITH (copy_data = false);`

`NOTICE:  created replication slot "test_sub_vm2" on publisher`

CREATE SUBSCRIPTION

- –£–¥–æ—Å—Ç–æ–≤–µ—Ä–∏–º—Å—è, —á—Ç–æ –≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –≤—ã–ø–æ–ª–Ω–∏–≤ –∫–æ–º–∞–Ω–¥—É(–≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã —Å–æ–∫—Ä–∞—â–µ–Ω):

`postgres=# \dRs+`

List of subscriptions

|   Name        |  Owner   | Enabled | Publication |                                  Conninfo                                | 
|---------------|----------|---------|-------------|--------------------------------------------------------------------------|
| test_sub_vm4  | postgres | t       | {test_pub}  |host=192.168.0.12 port=5432 user=postgres password=1 dbname=silunsky_repl |

---

- –ù–∞ –í–ú **postgres4** –Ω–∞—Å—Ç—Ä–æ–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –í–ú **postgres3**

`silunsky_repl=# CREATE SUBSCRIPTION test_sub_vm3 `

`CONNECTION 'host=192.168.0.13 port=5432 user=postgres password=1 dbname=silunsky_repl' `

`PUBLICATION test_pub WITH (copy_data = false);`

`NOTICE:  created replication slot "test_sub_vm3" on publisher`

CREATE SUBSCRIPTION

- –£–¥–æ—Å—Ç–æ–≤–µ—Ä–∏–º—Å—è, —á—Ç–æ –≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –≤—ã–ø–æ–ª–Ω–∏–≤ –∫–æ–º–∞–Ω–¥—É(–≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã —Å–æ–∫—Ä–∞—â–µ–Ω):

`postgres=# \dRs+`

List of subscriptions

|   Name        |  Owner   | Enabled | Publication |                                  Conninfo                                | 
|---------------|----------|---------|-------------|--------------------------------------------------------------------------|
| test_sub_vm3  | postgres | t       | {test_pub}  |host=192.168.0.13 port=5432 user=postgres password=1 dbname=silunsky_repl |

---

- –ù–∞ –í–ú **postgres5** –Ω–∞—Å—Ç—Ä–æ–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –í–ú **postgres3** –∏ –Ω–∞ –í–ú **postgres4**, –≤—ã–ø–æ–ª–Ω–∏–≤ —Å–æ–æ—Ç–≤–µ—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:

`silunsky_repl=# CREATE SUBSCRIPTION test_sub_vm3_on_vm5 `

`CONNECTION 'host=192.168.0.13 port=5432 user=postgres password=1 dbname=silunsky_repl' `

`PUBLICATION test_pub WITH (copy_data = false);`

`NOTICE:  created replication slot "test_sub_vm3_on_vm5" on publisher`

CREATE SUBSCRIPTION
 
`silunsky_repl=# CREATE SUBSCRIPTION test_sub_vm4_on_vm5 `

`CONNECTION 'host=192.168.0.12 port=5432 user=postgres password=1 dbname=silunsky_repl' `

`PUBLICATION test_pub WITH (copy_data = false);`

`NOTICE:  created replication slot "test_sub_vm4_on_vm5" on publisher`

CREATE SUBSCRIPTION

- –£–¥–æ—Å—Ç–æ–≤–µ—Ä–∏–º—Å—è, —á—Ç–æ –≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –≤—ã–ø–æ–ª–Ω–∏–≤ –∫–æ–º–∞–Ω–¥—É(–≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π):

`postgres=# \dRs+`

List of subscriptions
|        Name         |  Owner   | Enabled | Publication | Binary | Streaming | Two-phase commit | Disable on error | Origin | Password required | Run as owner? | Synchronous commit |                                 Conninfo                                  | Skip LSN |
|---------------------|----------|---------|-------------|--------|-----------|------------------|------------------|--------|-------------------|---------------|--------------------|---------------------------------------------------------------------------|----------|
| test_sub_vm4_on_vm5 | postgres | t       | {test_pub}  | f      | off       | d                | f                | any    | t                 | f             | off                | host=192.168.0.12 port=5432 user=postgres password=1 dbname=silunsky_repl | 0/0      |
| test_sub_vm3_on_vm5 | postgres | t       | {test_pub}  | f      | off       | d                | f                | any    | t                 | f             | off                | host=192.168.0.13 port=5432 user=postgres password=1 dbname=silunsky_repl | 0/0      |
(2 rows)

---

- [x] –ü–†–û–í–ï–†–ö–ê –ö–û–†–†–ï–ö–¢–ù–û–°–¢–ò –†–ê–ë–û–¢–´ –õ–û–ì–ò–ß–ï–°–ö–û–ô –†–ï–ü–õ–ò–ö–ê–¶–ò–ò:

- –í—Å—Ç–∞–≤–∏–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É **public.test** –Ω–∞ –í–ú **postgres3**:

`silunsky_repl=# insert into public.test (i) values (1), (2), (3), (4), (5), (6), (7), (8), (9), (10);`

INSERT 0 10

`silunsky_repl=#`

- –ü—Ä–æ–≤–µ—Ä–∏–º –∫–æ—Ä—Ä–µ—Ç–Ω–æ—Å—Ç—å:

`silunsky_repl=# select * from test;`

| i  | 
|----|
|  1 |
|  2 |
|  3 |
|  4 |
|  5 |
|  6 |
|  7 |
|  8 |
|  9 |
| 10 |
(10 rows)

---

- –í—Å—Ç–∞–≤–∏–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É **public.test2** –Ω–∞ –í–ú **postgres4**:

`silunsky_repl=# insert into public.test2 (i) values (11), (12), (13), (14), (15), (16), (17), (18), (19), (20);`

INSERT 0 10

`silunsky_repl=#`
  
- –ü—Ä–æ–≤–µ—Ä–∏–º –∫–æ—Ä—Ä–∫—Ç–Ω–æ—Å—Ç—å:

`silunsky_repl=# select * from test2;`

| i  | 
|----|
| 11 |
| 12 |
| 13 |
| 14 |
| 15 |
| 16 |
| 17 |
| 18 |
| 19 |
| 20 |
(10 rows)

--- 

- –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∏–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ä–∞–±–æ—Ç—ã –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ –í–ú **postgres5**:

`silunsky_repl=# select * from test;`

| i  | 
|----|
|  1 |
|  2 |
|  3 |
|  4 |
|  5 |
|  6 |
|  7 |
|  8 |
|  9 |
| 10 |
(10 rows)

`silunsky_repl=# select * from test2;`
  
| i  | 
|----|
| 11 |
| 12 |
| 13 |
| 14 |
| 15 |
| 16 |
| 17 |
| 18 |
| 19 |
| 20 |
(10 rows)

## üòÑ –ò—Ç–æ–≥: –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!   
