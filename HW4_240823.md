# –î–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ ‚Ññ4 (–∫ –∑–∞–Ω—è—Ç–∏—é –æ—Ç 24.08.23)

- [x] –ò—Å–ø–æ–ª—å–∑—É—é —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã "postgres2" —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ YC (–û–°:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] –î–æ–±–∞–≤–ª–µ–Ω ssh –∫–ª—é—á –≤ metadata –í–ú yc_key.pub;
- [x] –†–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–ª–∞—Å—Ç–µ—Ä –ë–î PostgreSQL 14;

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`14  main    5433 online postgres /var/lib/postgresql/14/main /var/log/postgresql/postgresql-14-main.log`

- [x] –°–æ–∑–¥–∞–Ω–∞ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö `testdb`;

`postgres=# \l`
                                                List of databases                                                  
                                                
|   Name    |  Owner   | Encoding |   Collate   |    Ctype    | ICU Locale | Locale Provider |   Access privileges   |
|-----------|----------|----------|-------------|-------------|------------|-----------------|----------------------- |
| postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            |                        |
| template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          + |
|           |          |          |             |             |            |                 | postgres=CTc/postgres  |
| template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          + |
|           |          |          |             |             |            |                 | postgres=CTc/postgres  |
| testdb    | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            |                        |
(4 rows)

---
 
- [x] –û—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–æ –ø–æ–¥–∫–ª—é—Å–µ–Ω–∏–µ –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö **testdb** –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º **postgres**;

`postgres=# \c testdb;`

`psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))`

`You are now connected to database "testdb" as user "postgres".`

- [x] –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ —Å—Ö–µ–º–∞ **testnm**;

`testdb=# CREATE SCHEMA testnm;`

`CREATE SCHEMA`

`testdb=# \dn`

   List of schemas 
|  Name  |  Owner  |   
|--------|---------|
| public | postgres|
| testnm | postgres|
(2 rows)


- [x] –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ **t1** —Å –æ–¥–Ω–æ–π –∫–æ–ª–æ–Ω–∫–æ–π **c1** —Ç–∏–ø–∞ **integer**. –ü–æ—Å–ª–µ —á–µ–≥–æ, –≤ —Ç–∞–±–ª–∏—Ü—É –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º **c1=1**:

`testdb=# CREATE TABLE t1(c1 integer);`

`CREATE TABLE`

`testdb=# SELECT * FROM t1;`

| c1 | 
|----|

(0 rows)

`testdb=# INSERT INTO t1 VALUES (1);`

`INSERT 0 1`

`testdb=# SELECT * FROM t1;`

| c1 | 
|----|
|  1 |

(1 row)

---

- [x] –°–æ–∑–¥–∞–Ω–∞ –†–æ–ª—å **readonly**:

`postgres=# CREATE role readonly;`

CREATE ROLE

`postgres=# \du`

List of roles

- [ RECORD 1 ]----------------------------------------------------------

Role name  | postgres

Attributes | Superuser, Create role, Create DB, Replication, Bypass RLS

Member of  | {}

- [ RECORD 2 ]----------------------------------------------------------

Role name  | readonly

Attributes | Cannot login

Member of  | {}

-[ RECORD 3 ]----------------------------------------------------------

Role name  | silunsky

Attributes | 

Member of  | {}

---

- [x] –†–æ–ª–∏ **readonly** –¥–∞–Ω–æ –ø—Ä–∞–≤–æ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î **testdb**:
      
`postgres=# GRANT CONNECT ON DATABASE testdb TO readonly;`

GRANT

`testdb=# \du`
                                   List of roles
                                   
| Role name |                         Attributes                         | Member of |
|-----------|------------------------------------------------------------|-----------|
| postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}        |
| readonly  | Cannot login                                               | {}        |
| silunsky  |                                                            | {}        |

---

- [x] –†–æ–ª–∏ **readonly** –¥–∞–Ω–æ –ø—Ä–∞–≤–æ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã **testnm**:

`testdb=# GRANT USAGE ON SCHEMA testnm TO readonly;`

GRANT

---

- [x] –†–æ–ª–∏ **readonly** –¥–∞–Ω–æ –ø—Ä–∞–≤–æ –Ω–∞ **SELECT** –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü —Å—Ö–µ–º—ã **testnm**:

`testdb=# GRANT SELECT ON ALL TABLES IN SCHEMA testnm TO readonly;`

GRANT

---

- [x] –°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **testread** —Å –ø–∞—Ä–æ–ª–µ–º **test123**:

`testdb=# CREATE USER testread WITH PASSWORD 'test123';`

CREATE ROLE

`testdb=# SELECT * FROM pg_user;`

| usename  | usesysid | usecreatedb | usesuper | userepl | usebypassrls |  passwd  | valuntil | useconfig |
|----------|----------|-------------|----------|---------|--------------|----------|----------|-----------|
| postgres |       10 | t           | t        | t       | t            | ******** |          | 
| silunsky |    16389 | f           | f        | f       | f            | ******** |          | 
| testread |    16391 | f           | f        | f       | f            | ******** |          | 
(3 rows)

---

- [x] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é **testread** –≤—ã–¥–∞–Ω–∞ –†–æ–ª—å **readonly**:

`testdb=# GRANT readonly TO testread;`

GRANT ROLE

---

- [x] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é **testread** –≤—ã–¥–∞–Ω–∞ –†–æ–ª—å **readonly**:

–î–∞–ª–µ–µ, –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º **testread** –∫ –ë–î **testdb** –ø–æ–ª—É—á–∞–µ–º –æ—à–∏–±–∫—É Peer –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

`postgres=# \c testdb testread;`
                       
connection to server on socket "/var/run/postgresql/.s.PGSQL.5433" failed: FATAL:  Peer authentication failed for user "testread"

Previous connection kept

–¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω–æ–π –æ—à–∏–±–∫–∏, –ø–µ—Ä–µ—Ö–æ–¥–º –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª `/etc/postgresql/14/main/pg_hba.conf`

–∏ –ø—Ä–∏–≤–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É

`# "local" is for Unix domain socket connections only`

`local   all             all                                     peer`

–∫ –≤–∏–¥—É

`# "local" is for Unix domain socket connections only`

`local   all             all                                     md5`

–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ –ö–ª–∞—Å—Ç–µ—Ä –ë–î. –ü–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î **testdb**

`postgres=# \c testdb testread;`

`Password for user testread: `

`psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))`

`You are now connected to database "testdb" as user "testread".`

`testdb=> `

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ `You are now connected to database "testdb" as user "testread"`, –æ–¥–Ω–∞–∫–æ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–¥–µ–ª–∞—Ç—å SELECT –ø–æ–ª—É—á–∞–µ–º –æ—à–∏–±–∫—É:

`testdb=> SELECT * FROM t1;`

`ERROR:  permission denied for table t1`

 `testdb=> \dt`
 
List of relations
       
| Schema | Name | Type  |  Owner   |
|--------|------|-------|----------|
| public | t1   | table | postgres |
(1 row)

–î–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–æ —Å –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞, —Ç.–∫. —Ç–∞–±–ª–∏—Ü–∞ **t1** —Å–æ–∑–¥–∞–Ω–∞ –≤ —Å—Ö–µ–º–µ **public**, –∞ –Ω–µ –≤ —Å—Ö–µ–º–µ **testnm** –∏ –ø—Ä–∞–≤ –Ω–∞ **public** –¥–ª—è —Ä–æ–ª–∏ **readonly** –Ω–∞ –ø—Ä–µ–¥—É—â–∏—Ö —à–∞–≥–∞—Ö —è –Ω–µ –≤—ã–¥–∞–≤–∞–ª. üò©

## –ò—Å–ø—Ä–∞–≤–ª—è—é –¥–∞–Ω–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é: üéØ

–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, —á—Ç–æ –ë–î **testdb** –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ä–∞–Ω—å—à–µ —Å—Ö–µ–º—ã **testnm**, –ø—Ä–∏ —Ç–æ–º —á—Ç–æ –Ω–µ –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –≤ search_path –∏ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —Ç–∞–±–ª–∏—Ü–∞ **t1** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ö–µ–º–µ **public** –∏ –∏ –ø—Ä–∞–≤ –Ω–∞ public –¥–ª—è —Ä–æ–ª–∏ **readonly** —Ä–∞–Ω–µ–µ –Ω–µ –¥–∞–≤–∞–ª.

- [x] –ü–µ—Ä–µ–∑–∞—Ö–æ–∂—É –≤ –ë–î **testdb** –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º **postgres**

`postgres=# \c testdb;`

`psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))`

`You are now connected to database "testdb" as user "postgres".`

`testdb=# `

- [x] –£–¥–∞–ª—è—é —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É **t1**

`testdb=# DROP TABLE t1;`

`DROP TABLE`

`testdb=# \dt`

`Did not find any relations.`

`testdb=# `

- [x] –°–æ–∑–¥–∞—é —Ç–∞–±–ª–∏—Ü—É **t1** —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ö–µ–º—ã **testnm**:

`testdb=# CREATE TABLE testnm.t1(c1 integer);`

CREATE TABLE

`testdb=# INSERT INTO testnm.t1 values(1);`

INSERT 0 1

- [x] –ü–æ—Å–ª–µ —á–µ–≥–æ –∑–∞—Ö–æ–∂—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö **testdb** –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º **testread** –∏ –ø—ã—Ç–∞—é—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å SELECT (–æ–¥–Ω–∞–∫–æ, –ø–æ–∫–∞ –Ω–µ —É–¥–∞—á–Ω–æ)
      
`postgres=# \c testdb testread;`

Password for user testread:

psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))

You are now connected to database "testdb" as user "testread".

`testdb=> select * from testnm.t1;`

ERROR:  permission denied for table t1

–û—à–∏–±–∫–∞ —Å–≤—è–∑–∞ —Å —Ç–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ `testdb=# GRANT SELECT ON ALL TABLES IN SCHEMA testnm TO readonly;`

–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –º–Ω–æ—é —Ä–∞–Ω–µ–µ –¥–∞–ª–∞ –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–∞ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ —Ç–∞–±–ª–∏—Ü, –∞ —Ç–∞–±–ª–∏—Ü–∞ **t1** –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å.

- [x] –°–Ω–æ–≤–∞ –∏—Å–ø—Ä–æ–∞–≤–ª—è—é —Å–∏—Ç—É–∞—Ü–∏—é ü§û g–µ—Ä–µ–∑–∞—Ö–æ–∂—É –≤ –ë–î **testdb** –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º **postgres**

`postgres=# \c testdb;`

`psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))`

`You are now connected to database "testdb" as user "postgres".`

–≤—ã–ø–æ–ª–Ω—è—é –∫–æ–º–∞–Ω–¥—É: `testdb=# ALTER DEFAULT PRIVILEGES IN SCHEMA testnm GRANT SELECT ON TABLES TO readonly;`

ALTER DEFAULT PRIVILEGES

–ù–æ –ø–æ—Å–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —Å–Ω–æ–≤–∞ –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫—É:

(You are now connected to database "testdb" as user "testread".)

`testdb=> select * from testnm.t1;`

ERROR:  permission denied for table t1

‚ö†Ô∏è –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, —á—Ç–æ `ALTER default` –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü, –∞ `GRANT SELECT ON ALL TABLES IN SCHEMA testnm TO readonly` –æ—Ç—Ä–∞–±–æ—Ç–∞–ª —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–∞ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏. –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å —Å–Ω–æ–≤–∞ `GRANT SELECT`:

`testdb=# GRANT USAGE ON SCHEMA testnm TO readonly;`

GRANT

`testdb=# GRANT SELECT ON ALL TABLES IN SCHEMA testnm TO readonly;`

GRANT

`testdb=# \c testdb testread;`

psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))

You are now connected to database "testdb" as user "testread".
 
`testdb=> select * FROM testnm.t1;`

| c1 | 
|----|
|  1 |
(1 row)

üòÑ **–ü–û–õ–£–ß–ò–õ–û–°–¨!!**

- [x] –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã **t2** –∏ **t3** –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º **postgres** –≤ —Å—Ö–µ–º–µ **testnm**, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **testread** –≤ –ø–æ—Å–ª–µ–¥–≤–∏–∏ –º–æ–∂–µ—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å SELECT –∏–∑ –≤–Ω–æ–≤—å —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü, —Ç.–∫. —É –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∞–≤–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —á—Ç–µ–Ω–∏–µ **readonly**

`testdb=> \c testdb postgres;`                                     

psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))

You are now connected to database "testdb" as user "postgres".
 
`testdb=# create table testnm.t2(c2 integer);`

CREATE TABLE

`testdb=# \dp`

Access privileges
| Schema | Name | Type  |     Access privileges     | Column privileges | Policies | 
|--------|------|-------|---------------------------|-------------------|----------|
| testnm | t1   | table | postgres=arwdDxt/postgres+|                   | 
|        |      |       | readonly=arwdDxt/postgres |                   | 
| testnm | t2   | table | postgres=arwdDxt/postgres+|                   | 
|        |      |       | readonly=r/postgres       |                   | 
(2 rows)

`testdb=# insert into t2 values (2);`

INSERT 0 1

`testdb=# create table t3(c3 integer);`

CREATE TABLE

`testdb=# insert into t2 values (3);`

INSERT 0 1

`testdb=# \dp`

Access privileges
| Schema | Name | Type  |     Access privileges     | Column privileges | Policies | 
|--------|------|-------|---------------------------|-------------------|----------|
| testnm | t1   | table | postgres=arwdDxt/postgres+|                   | 
|        |      |       | readonly=arwdDxt/postgres |                   | 
| testnm | t2   | table | postgres=arwdDxt/postgres+|                   | 
|        |      |       | readonly=r/postgres       |                   | 
| testnm | t3   | table | postgres=arwdDxt/postgres+|                   | 
|        |      |       | readonly=r/postgres       |                   | 
(3 rows)

`testdb=# \c testdb testread;`

Password for user testread: 

psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))

You are now connected to database "testdb" as user "testread".

`testdb=> select * FROM testnm.t2;`

| c2 |
|----|
|  2 |
|  3 |
(2 rows)

`testdb=> select * FROM testnm.t3;`

| c3| 
|----|
(0 rows)

testdb=> 





