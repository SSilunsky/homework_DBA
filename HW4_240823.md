# Ð”Ð¾Ð¼Ð°ÑˆÐ½ÑÑ Ñ€Ð°Ð±Ð¾Ñ‚Ð° â„–4 (Ðº Ð·Ð°Ð½ÑÑ‚Ð¸ÑŽ Ð¾Ñ‚ 24.08.23)

- [x] Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽ Ñ€Ð°Ð½ÐµÐµ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð¸Ð½ÑÑ‚Ð°Ð½Ñ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼Ð°ÑˆÐ¸Ð½Ñ‹ "postgres2" Ñ Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸ Ð² YC (ÐžÐ¡:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ ssh ÐºÐ»ÑŽÑ‡ Ð² metadata Ð’Ðœ yc_key.pub;
- [x] Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ ÐºÐ»Ð°ÑÑ‚ÐµÑ€ Ð‘Ð” PostgreSQL 14;

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`14  main    5433 online postgres /var/lib/postgresql/14/main /var/log/postgresql/postgresql-14-main.log`

- [x] Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… `testdb`;

`postgres=# \l`
                                                List of databases                                                  
                                                
|   Name    |  Owner   | Encoding |   Collate   |    Ctype    | ICU Locale | Locale Provider |   Access privileges   |
|-----------|----------|----------|-------------|-------------|------------|-----------------|----------------------- |
| postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            |                        |
| template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          + |
|           |          |          |             |             |            |                 | postgres=CTc/postgres  |
| template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          + |
|           |          |          |             |             |            |                 | postgres=CTc/postgres  |
| testdb    | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            |                        |
(4 rows)

---
 
- [x] ÐžÑÑƒÑ‰ÐµÑÑ‚Ð²Ð»ÐµÐ½Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑÐµÐ½Ð¸Ðµ Ðº ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ð¾Ð¹ Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… **testdb** Ð¿Ð¾Ð´ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ **postgres**;

`postgres=# \c testdb;`

`psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))`

`You are now connected to database "testdb" as user "postgres".`

- [x] Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð° ÑÑ…ÐµÐ¼Ð° **testnm**;

`testdb=# CREATE SCHEMA testnm;`

`CREATE SCHEMA`

`testdb=# \dn`

   List of schemas 
|  Name  |  Owner  |   
|--------|---------|
| public | postgres|
| testnm | postgres|
(2 rows)


- [x] Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° **t1** Ñ Ð¾Ð´Ð½Ð¾Ð¹ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¾Ð¹ **c1** Ñ‚Ð¸Ð¿Ð° **integer**. ÐŸÐ¾ÑÐ»Ðµ Ñ‡ÐµÐ³Ð¾, Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ Ð²ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð° ÑÑ‚Ñ€Ð¾ÐºÐ° ÑÐ¾ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÐµÐ¼ **c1=1**:

`testdb=# CREATE TABLE t1(c1 integer);`

`CREATE TABLE`

`testdb=# SELECT * FROM t1;`

| c1 | 
|----|

(0 rows)

`testdb=# INSERT INTO t1 VALUES (1);`

`INSERT 0 1`

`testdb=# SELECT * FROM t1;`

| c1 | 
|----|
|  1 |

(1 row)

---

- [x] Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð Ð¾Ð»ÑŒ **readonly**:

`postgres=# CREATE role readonly;`

CREATE ROLE

`postgres=# \du`

List of roles

- [ RECORD 1 ]----------------------------------------------------------

Role name  | postgres

Attributes | Superuser, Create role, Create DB, Replication, Bypass RLS

Member of  | {}

- [ RECORD 2 ]----------------------------------------------------------

Role name  | readonly

Attributes | Cannot login

Member of  | {}

-[ RECORD 3 ]----------------------------------------------------------

Role name  | silunsky

Attributes | 

Member of  | {}

---

- [x] Ð Ð¾Ð»Ð¸ **readonly** Ð´Ð°Ð½Ð¾ Ð¿Ñ€Ð°Ð²Ð¾ Ð½Ð° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” **testdb**:
      
`postgres=# GRANT CONNECT ON DATABASE testdb TO readonly;`

GRANT

`testdb=# \du`
                                   List of roles
                                   
| Role name |                         Attributes                         | Member of |
|-----------|------------------------------------------------------------|-----------|
| postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}        |
| readonly  | Cannot login                                               | {}        |
| silunsky  |                                                            | {}        |

---

- [x] Ð Ð¾Ð»Ð¸ **readonly** Ð´Ð°Ð½Ð¾ Ð¿Ñ€Ð°Ð²Ð¾ Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ…ÐµÐ¼Ñ‹ **testnm**:

`testdb=# GRANT USAGE ON SCHEMA testnm TO readonly;`

GRANT

---

- [x] Ð Ð¾Ð»Ð¸ **readonly** Ð´Ð°Ð½Ð¾ Ð¿Ñ€Ð°Ð²Ð¾ Ð½Ð° **SELECT** Ð´Ð»Ñ Ð²ÑÐµÑ… Ñ‚Ð°Ð±Ð»Ð¸Ñ† ÑÑ…ÐµÐ¼Ñ‹ **testnm**:

`testdb=# GRANT SELECT ON ALL TABLES IN SCHEMA testnm TO readonly;`

GRANT

---

- [x] Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ **testread** Ñ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¼ **test123**:

`testdb=# CREATE USER testread WITH PASSWORD 'test123';`

CREATE ROLE

`testdb=# SELECT * FROM pg_user;`

| usename  | usesysid | usecreatedb | usesuper | userepl | usebypassrls |  passwd  | valuntil | useconfig |
|----------|----------|-------------|----------|---------|--------------|----------|----------|-----------|
| postgres |       10 | t           | t        | t       | t            | ******** |          | 
| silunsky |    16389 | f           | f        | f       | f            | ******** |          | 
| testread |    16391 | f           | f        | f       | f            | ******** |          | 
(3 rows)

---

- [x] ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ **testread** Ð²Ñ‹Ð´Ð°Ð½Ð° Ð Ð¾Ð»ÑŒ **readonly**:

`testdb=# GRANT readonly TO testread;`

GRANT ROLE

---

- [x] ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ **testread** Ð²Ñ‹Ð´Ð°Ð½Ð° Ð Ð¾Ð»ÑŒ **readonly**:

Ð”Ð°Ð»ÐµÐµ, Ð¿Ñ€Ð¸ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ **testread** Ðº Ð‘Ð” **testdb** Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Peer Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸:

`postgres=# \c testdb testread;`
                       
connection to server on socket "/var/run/postgresql/.s.PGSQL.5433" failed: FATAL:  Peer authentication failed for user "testread"

Previous connection kept

Ð´Ð»Ñ ÑƒÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸, Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¼ Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» `/etc/postgresql/14/main/pg_hba.conf`

Ð¸ Ð¿Ñ€Ð¸Ð²Ð¾Ð´Ð¸Ð¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ

`# "local" is for Unix domain socket connections only`

`local   all             all                                     peer`

Ðº Ð²Ð¸Ð´Ñƒ

`# "local" is for Unix domain socket connections only`

`local   all             all                                     md5`

Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²Ð½ÐµÑÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°Ðµ ÐšÐ»Ð°ÑÑ‚ÐµÑ€ Ð‘Ð”. ÐŸÐ¾ÑÐ»Ðµ Ñ‡ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð‘Ð” **testdb**

`postgres=# \c testdb testread;`

`Password for user testread: `

`psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))`

`You are now connected to database "testdb" as user "testread".`

`testdb=> `

ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ `You are now connected to database "testdb" as user "testread"`, Ð¾Ð´Ð½Ð°ÐºÐ¾ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐµ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ SELECT Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ:

`testdb=> SELECT * FROM t1;`

`ERROR:  permission denied for table t1`

 `testdb=> \dt`
 
List of relations
       
| Schema | Name | Type  |  Owner   |
|--------|------|-------|----------|
| public | t1   | table | postgres |
(1 row)

Ð”Ð°Ð½Ð½Ð¾Ðµ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ ÑÐ²ÑÐ·Ð°Ð½Ð¾ Ñ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°, Ñ‚.Ðº. Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° **t1** ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð² ÑÑ…ÐµÐ¼Ðµ **public**, Ð° Ð½Ðµ Ð² ÑÑ…ÐµÐ¼Ðµ **testnm** Ð¸ Ð¿Ñ€Ð°Ð² Ð½Ð° **public** Ð´Ð»Ñ Ñ€Ð¾Ð»Ð¸ **readonly** Ð½Ð° Ð¿Ñ€ÐµÐ´ÑƒÑ‰Ð¸Ñ… ÑˆÐ°Ð³Ð°Ñ… Ñ Ð½Ðµ Ð²Ñ‹Ð´Ð°Ð²Ð°Ð». ðŸ˜©

## Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÑŽ Ð´Ð°Ð½Ð½ÑƒÑŽ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸ÑŽ: ðŸŽ¯

ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ ÑÐ²ÑÐ·Ð°Ð½Ð¾ Ñ Ñ‚ÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð‘Ð” **testdb** Ð±Ñ‹Ð»Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ñ€Ð°Ð½ÑŒÑˆÐµ ÑÑ…ÐµÐ¼Ñ‹ **testnm**, Ð¿Ñ€Ð¸ Ñ‚Ð¾Ð¼ Ñ‡Ñ‚Ð¾ Ð½Ðµ Ð±Ñ‹Ð»Ð¸ Ð²Ð½ÐµÑÐµÐ½Ñ‹ Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð² search_path Ð¸ Ñ‚Ð°ÐºÐ¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° **t1** Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² ÑÑ…ÐµÐ¼Ðµ **public** Ð¸ Ð¸ Ð¿Ñ€Ð°Ð² Ð½Ð° public Ð´Ð»Ñ Ñ€Ð¾Ð»Ð¸ **readonly** Ñ€Ð°Ð½ÐµÐµ Ð½Ðµ Ð´Ð°Ð²Ð°Ð».

- [x] ÐŸÐµÑ€ÐµÐ·Ð°Ñ…Ð¾Ð¶Ñƒ Ð² Ð‘Ð” **testdb** Ð¿Ð¾Ð´ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ **postgres**

`postgres=# \c testdb;`

`psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))`

`You are now connected to database "testdb" as user "postgres".`

`testdb=# `

- [x] Ð£Ð´Ð°Ð»ÑÑŽ Ñ€Ð°Ð½ÐµÐµ ÑÐ¾Ð·Ð´Ð°Ð½Ð½ÑƒÑŽ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ **t1**

`testdb=# DROP TABLE t1;`

`DROP TABLE`

`testdb=# \dt`

`Did not find any relations.`

`testdb=# `

- [x] Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ **t1** Ñ ÑÐ²Ð½Ñ‹Ð¼ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸ÐµÐ¼ ÑÑ…ÐµÐ¼Ñ‹ **testnm**:

`testdb=# CREATE TABLE testnm.t1(c1 integer);`

CREATE TABLE

`testdb=# INSERT INTO testnm.t1 values(1);`

INSERT 0 1

- [x] ÐŸÐ¾ÑÐ»Ðµ Ñ‡ÐµÐ³Ð¾ Ð·Ð°Ñ…Ð¾Ð¶Ñƒ Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… **testdb** Ð¿Ð¾Ð´ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ **testread** Ð¸ Ð¿Ñ‹Ñ‚Ð°ÑŽÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ SELECT (Ð¾Ð´Ð½Ð°ÐºÐ¾, Ð¿Ð¾ÐºÐ° Ð½Ðµ ÑƒÐ´Ð°Ñ‡Ð½Ð¾)
      
`postgres=# \c testdb testread;`

Password for user testread:

psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1), server 14.9 (Ubuntu 14.9-1.pgdg22.04+1))

You are now connected to database "testdb" as user "testread".

`testdb=> select * from testnm.t1;`

ERROR:  permission denied for table t1

 








