# Домашняя работа №6 (к занятию от 31.08.23)
[Работа с журналами]

- [x] Использую ранее созданный инстанс виртуальной машины "postgres2" с дефолтными параметрами в YC (ОС:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] Добавлен ssh ключ в metadata ВМ yc_key.pub;
- [x] Развернут кластер БД PostgreSQL 15;

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log`

Для тестов используется ранее созданная БД **silunsky** и таблица **otus**

postgres@postgres2:~$ psql 

psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1))

Type "help" for help.

`postgres=# \c silunsky_db `

You are now connected to database "silunsky_db" as user "postgres".

`silunsky_db=# select * from otus;`

| i | amount | 
|---|--------|
| 1 |    100 |
| 2 |    200 |
| 3 |    300 |
| 4 |    500 |
(4 rows)

- [x] Настроил выполнение контрольной точки раз в 30 секунд, выставив в конфигурационном файле `/etc/postgresql/15/main/postgresql.conf` параметр `checkpoint_timeout = 30s`
- [x] Запустил проверку тест производительности с параметрами: `pgbench -c8 -P 6 -T 600 -U postgres postgres` 
где:

-c8 # Число имитируемых клиентов, то есть число одновременных сеансов базы данных;

-P 6 # выводит отчёт о прогрессе через заданное число секунд (сек);

-T 600 # выполняет тест с ограничением по времени 10 минут(в секундах), а не по числу транзакций для каждого клиента. 

**10 минут c помощью утилиты pgbench подаю нагрузку.**

`postgres@postgres2:~$ pgbench -c8 -P 6 -T 60 -U postgres postgres`

pgbench (15.4 (Ubuntu 15.4-1.pgdg22.04+1))

starting vacuum...end.

transaction type: <builtin: TPC-B (sort of)>

scaling factor: 1

query mode: simple

number of clients: 8

number of threads: 1

maximum number of tries: 1

duration: 600 s

number of transactions actually processed: 224768

number of failed transactions: 0 (0.000%)

latency average = 21.355 ms

latency stddev = 19.306 ms

initial connection time = 14.590 ms

tps = 374.601759 (without initial connection time)



- [x] Определим, какой объем журнальных файлов был сгенерирован за это время. Оценим, какой объем приходится в среднем на одну контрольную точку.

для этого воспользуюемся командой:
`postgres=# SELECT * FROM pg_ls_waldir();`
получаем данные о колическтве сгенерированных WAL-файлов: 37 записей, т.к. размер WAL-файла фиксирован и составляет 16MB, то общий объем файлов = 592MB

Контрольные точкм создаются каждые 30 сек в течение 10 минут: получаем 20 контрольных точек, таким образом на одну контрольную точку в среднем приходится 592/20 = 30MB

|           name           |   size   |      modification     | 
|--------------------------|----------|------------------------|
| 000000010000000200000095 | 16777216 | 2023-08-29 08:35:23+00 |
| 00000001000000020000008D | 16777216 | 2023-08-29 08:35:10+00 |
| 00000001000000020000008E | 16777216 | 2023-08-29 08:34:52+00 |
| 0000000100000002000000A9 | 16777216 | 2023-08-29 08:48:36+00 |
| 000000010000000200000097 | 16777216 | 2023-08-29 08:35:25+00 |
| 000000010000000200000096 | 16777216 | 2023-08-29 08:34:52+00 |
| 0000000100000002000000A6 | 16777216 | 2023-08-29 08:35:32+00 |
 000000010000000200000099 | 16777216 | 2023-08-29 08:48:37+00 |
 0000000100000002000000A2 | 16777216 | 2023-08-29 08:35:29+00 |
 000000010000000200000094 | 16777216 | 2023-08-29 08:34:51+00 |
 00000001000000020000009F | 16777216 | 2023-08-29 08:35:26+00 |
 00000001000000020000008A | 16777216 | 2023-09-02 07:11:36+00 |
 000000010000000200000092 | 16777216 | 2023-08-29 08:34:53+00 |
 00000001000000020000009C | 16777216 | 2023-08-29 08:48:37+00 |
 00000001000000020000008F | 16777216 | 2023-08-29 08:34:54+00 |
 0000000100000002000000A1 | 16777216 | 2023-08-29 08:48:38+00 |
 00000001000000020000008B | 16777216 | 2023-09-02 07:12:34+00 |
 000000010000000200000093 | 16777216 | 2023-08-29 08:35:04+00 |
 00000001000000020000008C | 16777216 | 2023-09-02 07:16:07+00 |
 00000001000000020000009B | 16777216 | 2023-08-29 08:48:37+00 |
 000000010000000200000090 | 16777216 | 2023-08-29 08:35:21+00 |
 00000001000000020000009D | 16777216 | 2023-08-29 08:35:30+00 |
 0000000100000002000000A3 | 16777216 | 2023-08-29 08:35:28+00 |
 0000000100000002000000AC | 16777216 | 2023-08-29 08:48:39+00 |
 000000010000000200000098 | 16777216 | 2023-08-29 08:35:31+00
 00000001000000020000009A | 16777216 | 2023-08-29 08:48:38+00
 0000000100000002000000A0 | 16777216 | 2023-08-29 08:35:28+00
 0000000100000002000000AA | 16777216 | 2023-08-29 08:35:27+00
 0000000100000002000000AB | 16777216 | 2023-08-29 08:35:27+00
 0000000100000002000000A7 | 16777216 | 2023-08-29 08:35:27+00
 00000001000000020000009E | 16777216 | 2023-08-29 08:35:25+00
 0000000100000002000000AD | 16777216 | 2023-08-29 08:35:31+00
 0000000100000002000000AE | 16777216 | 2023-08-29 08:48:38+00
 0000000100000002000000A4 | 16777216 | 2023-08-29 08:35:32+00
 0000000100000002000000A5 | 16777216 | 2023-08-29 08:35:29+00
 000000010000000200000091 | 16777216 | 2023-08-29 08:35:21+00
 0000000100000002000000A8 | 16777216 | 2023-08-29 08:48:38+00
(37 rows)
