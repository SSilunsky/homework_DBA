# Домашняя работа №11 (к занятию от 02.10.23)
[Виды индексов. Работа с индексами и оптимизация запросов]

- [x] Использую ранее созданный инстанс виртуальной машины "postgres2" с дефолтными параметрами в YC (ОС:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] Добавлен ssh ключ в metadata ВМ yc_key.pub;
- [x] Развернут кластер БД PostgreSQL 15;

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log`

- [x] В БД **silunsky_db** создадим таблицу **otus1**. Создадим индекс на таблицу **otus1**.

`silunsky_db=# create table otus1 as`

`select generate_series as id`

`    , generate_series::text || (random() * 10)::text as col2`

    , (array['Yes', 'No', 'Maybe'])[floor(random() * 3 + 1)] as is_okay
`from generate_series(1, 50000);`

`create index idx_otus1_id on otus1(id);`

SELECT 50000

CREATE INDEX

выполним проверку с помощью команды 

`silunsky_db=# \di+`

List of relations

| Schema |         Name          | Type  |  Owner   |      Table       | Persistence | Access method |  Size   | 
|--------|-----------------------|-------|----------|------------------|-------------|---------------|---------|
| public | idx_otus1_id          | index | postgres | otus1            | permanent   | btree         | 1112 kB | 

`silunsky_db=# select pg_size_pretty(pg_table_size('otus1'));`

| pg_size_pretty |
|----------------|
| 3104 kB        |
(1 row)

`silunsky_db=# select pg_size_pretty(pg_table_size('idx_otus1_id'));`

| pg_size_pretty |
|----------------|
|3104 kB         |
(1 row)

---

- [x] Прислать текстом результат команды explain, в которой используется индекс **idx_otus1_id**

для этого выполним следующую команду:

`silunsky_db=# explain`

`select id from otus1 where id = 1;`

|QUERY PLAN                                                                      |
|------------------------------------------------------------------------------- |
| Index Only Scan using idx_otus1_id on otus1  (cost=0.29..1.41 rows=1 width=4)  |
|   Index Cond: (id = 1)                                                         |
(2 rows)

---

- [x] Реализовать индекс для полнотекстового поиска

Создадим уникальный индекс для полнотекстового поиска

`silunsky_db=# create unique index idx_otusU_id on otus1(id);`

CREATE INDEX

`silunsky_db=# explain select id`

`from otus1`

`order by id;`

| QUERY PLAN                                                                          |
|-------------------------------------------------------------------------------------|
| Index Only Scan using idx_otusu_id on otus1  (cost=0.29..906.32 rows=50002 width=4) |
(1 row)

- Индексы ускоряют работу БД, а по мере ее разрастания их эффективность становится очевиднее. При этом важно помнить о том, что индексам необходимо место для хранения. При добавлении данных в БД сначала обновляется исходная таблица, а затем все ее индексы. В связи с этим, лучше использовать индексы для БД в хранилищах данных, получающих плановые обновления, т.е. в часы наименьшей нагрузки, а не для производственных, которые обновляются постоянно. Это объясняется тем, что при постоянных обновлениях БД индексы обновляться не будут, а следовательно станут бесполезны. 

---

- [x] Реализуем индекс на часть таблицы и индекс на поле с функцией:

- Создадим индекс **idx_otus1_id_100** на часть таблицы **otus1**:

`silunsky_db=# create index idx_otus1_id_100 on otus1(id) where id < 100;`

CREATE INDEX

`silunsky_db=# explain`

`select * from otus1 where id < 50;`

| QUERY PLAN                                                                 |
|----------------------------------------------------------------------------|
| Index Scan using idx_otusu_id on otus1  (cost=0.29..3.38 rows=51 width=31) |
|   Index Cond: (id < 50)                                                    |
(2 rows)

- Создадим индекс на поле с функцией:

`silunsky_db=# create index idx_otus1_id_is_okay on otus1(lower(is_okay));`

CREATE INDEX

`silunsky_db=# explain`

`select * from otus1 where lower(is_okay) = 'True';`

| QUERY PLAN                                                                          |
|-------------------------------------------------------------------------------------|
| Bitmap Heap Scan on otus1  (cost=3.33..201.70 rows=250 width=31)                    |
|   Recheck Cond: (lower(is_okay) = 'True'::text)                                     | 
|   ->  Bitmap Index Scan on idx_otus1_id_is_okay  (cost=0.00..3.27 rows=250 width=0) |
|        Index Cond: (lower(is_okay) = 'True'::text)                                  |
(4 rows)

---













