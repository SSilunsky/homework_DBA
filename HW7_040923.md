# –î–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ ‚Ññ7 (–∫ –∑–∞–Ω—è—Ç–∏—é –æ—Ç 04.09.23)
[–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏]

- [x] –ò—Å–ø–æ–ª—å–∑—É—é —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã "postgres2" —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ YC (–û–°:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] –î–æ–±–∞–≤–ª–µ–Ω ssh –∫–ª—é—á –≤ metadata –í–ú yc_key.pub;
- [x] –†–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–ª–∞—Å—Ç–µ—Ä –ë–î PostgreSQL 15;

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log`

- [x] –ù–∞—Å—Ç—Ä–æ–∏–º —Å–µ—Ä–≤–µ—Ä —Ç–∞–∫, —á—Ç–æ–±—ã –≤ –∂—É—Ä–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π —Å–±—Ä–∞—Å—ã–≤–∞–ª–∞—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö, —É–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –±–æ–ª–µ–µ 200 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥;

–î–ª—è —ç—Ç–æ–≥–æ –≤–∫–ª—é—á–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä `log_lock_waits`

`postgres@postgres2:~$ psql`

psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1))

Type "help" for help.

`postgres=# SHOW deadlock_timeout;`

| deadlock_timeout |
|------------------|
| 1s               |
(1 row)

`postgres=# SHOW log_lock_waits;`

| log_lock_waits  | 
|---------------- |
| off             |
(1 row)

`postgres=# ALTER SYSTEM SET log_lock_waits = on;`

ALTER SYSTEM

`postgres=# SELECT pg_reload_conf();`

| pg_reload_conf  | 
|---------------- |
| t               |
(1 row)

`postgres=# SHOW log_lock_waits;`

| log_lock_waits  | 
|---------------- |
| on              |
(1 row)

–í–Ω–æ—Å–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∫–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª `/etc/postgresql/15/main/postgresql.conf`

LOCK MANAGEMENT:

deadlock_timeout = 200ms

- [x] –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Å–∏—Ç—É–∞—Ü–∏—é, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –≤ –∂—É—Ä–Ω–∞–ª–µ –ø–æ—è–≤—è—Ç—Å—è —Ç–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
      
**[–°–ï–°–°–ò–Ø ‚Ññ1]** 

`silunsky_db=# select * from otus;`

| i  | amount | 
|----|--------|
|  2 |    200 |
|  3 |    300 |
|  4 |    500 |
| 10 |    100 |
(4 rows)

`silunsky_db=# BEGIN; `

`UPDATE otus SET amount = amount - 100 WHERE i = 2;`

BEGIN

UPDATE 1

`silunsky_db=*#` 

---

–í—Ö–æ–¥–∏–º –≤ –µ—â–µ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ –∏ –¥–µ–ª–∞–µ–º –µ—â—ë –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:

**[–°–ï–°–°–ò–Ø ‚Ññ2]** 

`postgres=# \c silunsky_db`

You are now connected to database "silunsky_db" as user "postgres".

`silunsky_db=# BEGIN;`

`UPDATE otus SET amount = amount + 100 WHERE i = 2;`

BEGIN

|

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]** 

`silunsky_db=*# SELECT pg_sleep(10);`

|pg_sleep  | 
|----------|
(1 row)

–∑–∞–≤–µ—Ä—à–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:

`silunsky_db=*# COMMIT;`

COMMIT

---

**[–°–ï–°–°–ò–Ø ‚Ññ2]**

–ø–æ—Å–ª–µ —á–µ–≥–æ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤–æ –≤—Ç–æ—Ä–æ–π —Å–µ—Å—Å–∏–∏:

`silunsky_db=*# COMMIT;`

COMMIT

- [x] –ü–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥–µ:

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]** 

`postgres@postgres2:~$ tail -n 20 /var/log/postgresql/postgresql-15-main.log `

- 2023-09-05 06:42:11.170 UTC [1830] postgres@postgres STATEMENT:  SET deadlock_timeout = 200ms;
- 2023-09-05 06:50:19.279 UTC [806] LOG:  checkpoint starting: time
- 2023-09-05 06:50:19.402 UTC [806] LOG:  checkpoint complete: wrote 1 buffers (0.0%); 0 WAL file(s) added, 0 removed, 0 recycled; write=0.101 s, sync=0.007 s, total=0.123 s; sync files=1, longest=0.007 s, average=0.007 s; distance=0 kB, estimate=0 kB
- 2023-09-05 06:51:37.750 UTC [2027] postgres@silunsky_db LOG:  process 2027 still waiting for ShareLock on transaction 865201 after 1000.119 ms
- 2023-09-05 06:51:37.750 UTC [2027] postgres@silunsky_db DETAIL:  Process holding the lock: 1870. Wait queue: 2027.
- 2023-09-05 06:51:37.750 UTC [2027] postgres@silunsky_db CONTEXT:  while updating tuple (0,2) in relation "otus"
- 2023-09-05 06:51:37.750 UTC [2027] postgres@silunsky_db STATEMENT:  UPDATE otus SET amount = amount + 100 WHERE i = 2;
- 2023-09-05 07:03:18.348 UTC [2027] postgres@silunsky_db LOG:  process 2027 acquired ShareLock on transaction 865201 after 701597.793 ms
- 2023-09-05 07:03:18.348 UTC [2027] postgres@silunsky_db CONTEXT:  while updating tuple (0,2) in relation "otus"

üòÑ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, –≤ –ª–æ–≥–µ —Ç–µ–ø–µ—Ä—å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–ø–∏—Å–∏ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö, —É–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –±–æ–ª–µ–µ 200 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥.

---
