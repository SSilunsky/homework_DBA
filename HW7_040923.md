# –î–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ ‚Ññ7 (–∫ –∑–∞–Ω—è—Ç–∏—é –æ—Ç 04.09.23)
[–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏]

- [x] –ò—Å–ø–æ–ª—å–∑—É—é —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã "postgres2" —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ YC (–û–°:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] –î–æ–±–∞–≤–ª–µ–Ω ssh –∫–ª—é—á –≤ metadata –í–ú yc_key.pub;
- [x] –†–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–ª–∞—Å—Ç–µ—Ä –ë–î PostgreSQL 15;

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log`

- [x] –ù–∞—Å—Ç—Ä–æ–∏–º —Å–µ—Ä–≤–µ—Ä —Ç–∞–∫, —á—Ç–æ–±—ã –≤ –∂—É—Ä–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π —Å–±—Ä–∞—Å—ã–≤–∞–ª–∞—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö, —É–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –±–æ–ª–µ–µ 200 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥;

–î–ª—è —ç—Ç–æ–≥–æ –≤–∫–ª—é—á–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä `log_lock_waits`

`postgres@postgres2:~$ psql`

psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1))

Type "help" for help.

`postgres=# SHOW deadlock_timeout;`

| deadlock_timeout |
|------------------|
| 1s               |
(1 row)

`postgres=# SHOW log_lock_waits;`

| log_lock_waits  | 
|---------------- |
| off             |
(1 row)

`postgres=# ALTER SYSTEM SET log_lock_waits = on;`

ALTER SYSTEM



`postgres=# SELECT pg_reload_conf();`

| pg_reload_conf  | 
|---------------- |
| t               |
(1 row)

`postgres=# SHOW log_lock_waits;`

| log_lock_waits  | 
|---------------- |
| on              |
(1 row)

–í–Ω–æ—Å–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∫–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª `/etc/postgresql/15/main/postgresql.conf`

`postgres=# alter system set deadlock_timeout = 200;  `

ALTER SYSTEM

–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–º–µ–Ω–∏—Å—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

`postgres@postgres2:~$ pg_ctlcluster 15 main stop`

`postgres@postgres2:~$ pg_ctlcluster 15 main start`

`postgres=# SHOW deadlock_timeout;`

| deadlock_timeout |
|------------------|
| 200ms            |
(1 row)

- [x] –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Å–∏—Ç—É–∞—Ü–∏—é, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –≤ –∂—É—Ä–Ω–∞–ª–µ –ø–æ—è–≤—è—Ç—Å—è —Ç–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
      
**[–°–ï–°–°–ò–Ø ‚Ññ1]** 

`silunsky_db=# select * from otus;`

| i  | amount | 
|----|--------|
|  2 |    200 |
|  3 |    300 |
|  4 |    500 |
| 10 |    100 |
(4 rows)

`silunsky_db=# BEGIN; `

`UPDATE otus SET amount = amount - 100 WHERE i = 2;`

BEGIN

UPDATE 1

`silunsky_db=*#` 

–í—ã–≤–µ–¥–µ–º –Ω–æ–º–µ—Ä –æ–±—Å–ª—É–∂–∏–≤–∞—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞:

`silunsky_db=*# SELECT pg_backend_pid();`

| pg_backend_pid | 
|----------------|
|           1789 |
(1 row)

---

–í—Ö–æ–¥–∏–º –≤ –µ—â–µ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ –∏ –¥–µ–ª–∞–µ–º –µ—â—ë –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:

**[–°–ï–°–°–ò–Ø ‚Ññ2]** 

`postgres=# \c silunsky_db`

You are now connected to database "silunsky_db" as user "postgres".

`silunsky_db=# BEGIN;`

`UPDATE otus SET amount = amount + 100 WHERE i = 2;`

BEGIN

|(–≤–∏—Å–∏—Ç)

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]** 

`silunsky_db=*# SELECT pg_sleep(10);`

|pg_sleep  | 
|----------|
(1 row)

–∑–∞–≤–µ—Ä—à–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:

`silunsky_db=*# COMMIT;`

COMMIT

---

**[–°–ï–°–°–ò–Ø ‚Ññ2]**

–í—ã–≤–µ–¥–µ–º –Ω–æ–º–µ—Ä –æ–±—Å–ª—É–∂–∏–≤–∞—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞:

`silunsky_db=*# SELECT pg_backend_pid();`

| pg_backend_pid | 
|----------------|
|           1838 |
(1 row)

–ø–æ—Å–ª–µ —á–µ–≥–æ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤–æ –≤—Ç–æ—Ä–æ–π —Å–µ—Å—Å–∏–∏:

`silunsky_db=*# COMMIT;`

COMMIT

- [x] –ü–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥–µ:

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]** 

`postgres@postgres2:~$ tail -n 20 /var/log/postgresql/postgresql-15-main.log `

- 2023-09-05 06:42:11.170 UTC [1830] postgres@postgres STATEMENT:  SET deadlock_timeout = 200ms;
- 2023-09-05 06:50:19.279 UTC [806] LOG:  checkpoint starting: time
- 2023-09-05 11:39:26.671 UTC [805] LOG:  checkpoint complete: wrote 2 buffers (0.0%); 0 WAL file(s) added, 0 removed, 0 recycled; write=0.104 s, sync=0.007 s, total=0.135 s; sync files=2, longest=0.005 s, average=0.004 s; distance=0 kB, estimate=0 kB
- 2023-09-05 11:42:21.714 UTC [1838] postgres@silunsky_db LOG:  process 1838 still waiting for ShareLock on transaction 865207 after 1000.068 ms
- 2023-09-05 11:42:21.714 UTC [1838] postgres@silunsky_db DETAIL:  Process holding the lock: 1789. Wait queue: 1838.
- 2023-09-05 11:42:21.714 UTC [1838] postgres@silunsky_db CONTEXT:  while updating tuple (0,10) in relation "otus"
- 2023-09-05 11:42:21.714 UTC [1838] postgres@silunsky_db STATEMENT:  UPDATE otus SET amount = amount + 100 WHERE i = 2;
- 2023-09-05 11:43:54.841 UTC [1838] postgres@silunsky_db LOG:  process 1838 acquired ShareLock on transaction 865207 after 94127.523 ms
- 2023-09-05 11:43:54.841 UTC [1838] postgres@silunsky_db CONTEXT:  while updating tuple (0,10) in relation "otus"
- 2023-09-05 11:43:54.841 UTC [1838] postgres@silunsky_db STATEMENT:  UPDATE otus SET amount = amount + 100 WHERE i = 2;
- 2023-09-05 11:44:26.704 UTC [805] LOG:  checkpoint starting: time
- 2023-09-05 11:44:26.822 UTC [805] LOG:  checkpoint complete: wrote 2 buffers (0.0%); 0 WAL file(s) added, 0 removed, 0 recycled; write=0.103 s, sync=0.004 s, total=0.118 s; sync files=2, longest=0.003 s, average=0.002 s; distance=0 kB, estimate=0 kB

üòÑ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, –≤ –ª–æ–≥–µ —Ç–µ–ø–µ—Ä—å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–ø–∏—Å–∏ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö, —É–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –±–æ–ª–µ–µ 200 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥.

---

- [x] –°–º–æ–¥–µ–ª–∏—Ä—É–µ–º —Å–∏—Ç—É–∞—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–∏ —Ç—Ä–µ–º—è –∫–æ–º–∞–Ω–¥–∞–º–∏ UPDATE –≤ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Å—Å–∏—è—Ö. –ò–∑—É—á–∏—Ç–µ –≤–æ–∑–Ω–∏–∫—à–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ pg_locks –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –æ–Ω–∏ –ø–æ–Ω—è—Ç–Ω—ã. –ü—Ä–∏—à–ª–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∏ –æ–±—ä—è—Å–Ω–∏—Ç–µ, —á—Ç–æ –∑–Ω–∞—á–∏—Ç –∫–∞–∂–¥–∞—è.

- –ù–∞—á–Ω–µ–º —Å —Ç–æ–≥–æ, —á—Ç–æ –ø–æ—Å—Ç—Ä–æ–∏–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–¥ pg_locks:

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`silunsky_db=# CREATE VIEW locks_v AS`

`SELECT pid,`

`locktype,`

`CASE locktype`

`WHEN 'relation' THEN relation::regclass::text`

`WHEN 'transactionid' THEN transactionid::text`

`WHEN 'tuple' THEN relation::regclass::text||':'||tuple::text`

`END AS lockid,`

`mode,`

`granted`

`FROM pg_locks

`WHERE locktype in ('relation','transactionid','tuple')`

`AND (locktype != 'relation' OR relation = 'otus'::regclass);`

CREATE VIEW

–¢–µ–ø–µ—Ä—å –Ω–∞—á–Ω–µ–º –ø–µ—Ä–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –æ–±–Ω–æ–≤–∏–º —Å—Ç—Ä–æ–∫—É:

silunsky_db=# BEGIN;

BEGIN

`silunsky_db=*# SELECT txid_current(), pg_backend_pid();`

| txid_current | pg_backend_pid  | 
|--------------|---------------- |
|       865210 |           1789  |
(1 row)

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 3;`

UPDATE 1

`silunsky_db=*# SELECT * FROM locks_v WHERE pid = 1789;`

| pid  |   locktype    | lockid |       mode       | granted  |
|------|---------------|--------|------------------|--------- |
| 1789 | relation      | otus   | RowExclusiveLock | t        |
| 1789 | transactionid | 865211 | ExclusiveLock    | t        |
(2 rows)

---

**[–°–ï–°–°–ò–Ø ‚Ññ2]**

`silunsky_db=# BEGIN;`

BEGIN

`silunsky_db=*# SELECT txid_current(), pg_backend_pid();`

| txid_current | pg_backend_pid | 
|--------------|----------------|
|       865212 |           2149 |
(1 row)

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 3;`

| (–≤–∏—Å–∏—Ç)

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`silunsky_db=*# SELECT * FROM locks_v WHERE pid = 2149;`

| pid  |   locktype    | lockid |       mode       | granted |
|------|---------------|--------|------------------|---------|
| 2149 | relation      | otus   | RowExclusiveLock | t       |
| 2149 | transactionid | 865212 | ExclusiveLock    | t       |
| 2149 | tuple         | otus:3 | ExclusiveLock    | t       |
| 2149 | transactionid | 865211 | ShareLock        | f       |
(4 rows)

–ü–æ–º–∏–º–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞, –º—ã –≤–∏–¥–∏–º –µ—â–µ –¥–≤–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.

---

**[–°–ï–°–°–ò–Ø ‚Ññ3]**

`silunsky_db=# BEGIN;   `               

BEGIN

`silunsky_db=*# SELECT txid_current(), pg_backend_pid();`

| txid_current | pg_backend_pid |
|--------------|----------------|
|       865213 |           3059 |
(1 row)

`silunsky_db=*# `

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 3;`

| (–≤–∏—Å–∏—Ç)

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`silunsky_db=*# SELECT * FROM locks_v WHERE pid = 3059;`

| pid  |   locktype    | lockid |       mode       | granted  |
|------|---------------|--------|------------------|--------- |
| 3059 | relation      | otus   | RowExclusiveLock | t        |
| 3059 | tuple         | otus:3 | ExclusiveLock    | f        |
| 3059 | transactionid | 865213 | ExclusiveLock    | t        |
(3 rows)

 –ü–æ–ª—É—á–∞–µ—Ç—Å—è —Å–≤–æ–µ–æ–±—Ä–∞–∑–Ω–∞—è ¬´–æ—á–µ—Ä–µ–¥—å¬ª, –≤ –∫–æ—Ç–æ—Ä–æ–π –µ—Å—Ç—å –ø–µ—Ä–≤—ã–π (—Ç–æ—Ç, –∫—Ç–æ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫–∏) –∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ.

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`silunsky_db=*# commit;`

COMMIT

` silunsky_db=# SELECT * FROM locks_v WHERE pid = 2149;`

| pid  |   locktype    | lockid |       mode       | granted  |
|------|---------------|--------|------------------|--------- |
| 2149 | relation      | otus   | RowExclusiveLock | t        |
| 2149 | transactionid | 865212 | ExclusiveLock    | t        |
(2 rows)

---

**[–°–ï–°–°–ò–Ø ‚Ññ2]**

`silunsky_db=*# commit;`

COMMIT

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`silunsky_db=# SELECT * FROM locks_v WHERE pid = 3059;`

| pid  |   locktype    | lockid |       mode       | granted  | 
|------|---------------|--------|------------------|--------- |
| 3059 | relation      | otus   | RowExclusiveLock | t        |
| 3059 | transactionid | 865213 | ExclusiveLock    | t        |
(2 rows)

`silunsky_db=# SELECT * FROM locks_v WHERE pid = 2149;`

| pid | locktype | lockid | mode | granted  | 
|-----|----------|--------|------|--------- |
(0 rows)

---

**[–°–ï–°–°–ò–Ø ‚Ññ3]**

`silunsky_db=*# commit;`

COMMIT

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`silunsky_db=# SELECT * FROM locks_v WHERE pid = 2149;`

| pid | locktype | lockid | mode | granted |
|-----|----------|--------|------|---------|
(0 rows)

`silunsky_db=# SELECT * FROM locks_v WHERE pid = 3059;`

| pid | locktype | lockid | mode | granted  |
|-----|----------|--------|------|--------- |
(0 rows)

---

–ü—Ä–∏ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–∏ —Ç—Ä–µ–º—è –∫–æ–º–∞–Ω–¥–∞–º–∏ UPDATE –≤ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Å—Å–∏—è—Ö –∏–º–µ–ª–∏ –º–µ—Å—Ç–æ —Å–∏—Ç—É–∞—Ü–∏–∏ —Å —Ç—Ä–µ–º—è —Ç–∏–ø–∞–º–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:

- RowExclusiveLock - –ö–æ–º–∞–Ω–¥—ã UPDATE, DELETE, INSERT –∏ MERGE –ø–æ–ª—É—á–∞—é—Ç —Ç–∞–∫—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è —Ü–µ–ª–µ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã. –í–æ–æ–±—â–µ –≥–æ–≤–æ—Ä—è, –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –ø–æ–ª—É—á–∞–µ—Ç –ª—é–±–∞—è –∫–æ–º–∞–Ω–¥–∞, –∫–æ—Ç–æ—Ä–∞—è –∏–∑–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ.
- ExclusiveLock - –ö–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å —Ä–µ–∂–∏–º–∞–º–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ROW SHARE, ROW EXCLUSIVE, SHARE UPDATE EXCLUSIVE, SHARE, SHARE ROW EXCLUSIVE, EXCLUSIVE –∏ ACCESS EXCLUSIVE. –≠—Ç–æ—Ç —Ä–µ–∂–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º —Ç–æ–ª—å–∫–æ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π ACCESS SHARE, —Ç–æ –µ—Å—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π, –ø–æ–ª—É—á–∏–≤—à–µ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ, –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã.
- ShareLock - –ö–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å —Ä–µ–∂–∏–º–∞–º–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ROW EXCLUSIVE, SHARE UPDATE EXCLUSIVE, SHARE ROW EXCLUSIVE, EXCLUSIVE –∏ ACCESS EXCLUSIVE. –≠—Ç–æ—Ç —Ä–µ–∂–∏–º –∑–∞—â–∏—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

---

- [x] –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–º –≤–∑–∞–∏–º–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Ç—Ä–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`ssilunsky_db=# BEGIN;`

BEGIN

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 2;`

UPDATE 1

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 4;`

UPDATE 1

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 3;`

**[–°–ï–°–°–ò–Ø ‚Ññ2]**

`silunsky_db=*# BEGIN; ` 

`UPDATE otus SET amount = amount + 100 WHERE i = 4;`

WARNING:  there is already a transaction in progress

BEGIN

UPDATE 1

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 2;`

UPDATE 1

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 3;`

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 4;

| (–≤–∏—Å–∏—Ç)


**[–°–ï–°–°–ò–Ø ‚Ññ3]**

`silunsky_db=# BEGIN;`

BEGIN

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 4;`

UPDATE 1

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 2;`

UPDATE 1

`silunsky_db=*# UPDATE otus SET amount = amount + 100 WHERE i = 3;`

–ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤–∑–∞–∏–º–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ:

ERROR:  deadlock detected

DETAIL:  Process 3059 waits for ShareLock on transaction 865217; blocked by process 2149.

Process 2149 waits for ShareLock on transaction 865216; blocked by process 1789.

Process 1789 waits for ShareLock on transaction 865218; blocked by process 3059.

HINT:  See server log for query details.

CONTEXT:  while updating tuple (0,16) in relation "otus"

–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Ä–∞–∑–æ–±–∞—Ç—å—Å—è –≤ –≤–æ–∑–Ω–∏–∫—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥:

`postgres@postgres2:~$ tail -n 100 /var/log/postgresql/postgresql-15-main.log | grep -i 'blocked by'`

- 2023-09-05 15:08:34.051 UTC [2149] postgres@silunsky_db DETAIL:  Process 2149 waits for ShareLock on transaction 865214; blocked by process 1789.
- Process 1789 waits for ShareLock on transaction 865215; blocked by process 2149.
- 2023-09-05 15:18:43.700 UTC [3059] postgres@silunsky_db DETAIL:  Process 3059 waits for ShareLock on transaction 865217; blocked by process 2149.
- Process 2149 waits for ShareLock on transaction 865216; blocked by process 1789.
- Process 1789 waits for ShareLock on transaction 865218; blocked by process 3059.
- 2023-09-05 15:21:21.997 UTC [1789] postgres@silunsky_db DETAIL:  Process 1789 waits for ShareLock on transaction 865217; blocked by process 2149.
- Process 2149 waits for ShareLock on transaction 865216; blocked by process 1789.

`postgres@postgres2:~$ tail -n 100 /var/log/postgresql/postgresql-15-main.log | grep -i 'deadlock detected'`

- 2023-09-05 15:08:34.051 UTC [2149] postgres@silunsky_db ERROR:  deadlock detected
- 2023-09-05 15:18:43.700 UTC [3059] postgres@silunsky_db ERROR:  deadlock detected
- 2023-09-05 15:21:21.997 UTC [1789] postgres@silunsky_db ERROR:  deadlock detected

üòÑ –í –∂—É—Ä–Ω–∞–ª–µ –≤–∏–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–Ω–∏—Å–∏ –æ –≤–∑–∞–∏–º–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º–æ–∂–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–æ—Å—Ç—Ñ–∞–∫—Ç—É–º, –∏–∑—É—á–∞—è –∂—É—Ä–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π.

---
## –ó–∞–¥–∞–Ω–∏–µ —Å–æ (*): –ú–æ–≥—É—Ç –ª–∏ –¥–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É UPDATE –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Ç–∞–±–ª–∏—Ü—ã (–±–µ–∑ where), –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞?

- –í–∑–∞–∏–º–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ 2-—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –≤—ã–ø–æ–ª–Ω—è—é—â–∏—Ö UPDATE –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Ç–∞–±–ª–∏—Ü—ã (–±–µ–∑ where) –≤–æ–∑–º–æ–∂–Ω–∞, –µ—Å–ª–∏ –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –≤ –ø—Ä—è–º–æ–º –ø–æ—Ä—è–¥–∫–µ, –∞ –¥—Ä—É–≥–∞—è - –≤ –æ–±—Ä–∞—Ç–Ω–æ–º üôÇ
- –¢–∞–∫–æ–µ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏, —Ö–æ—Ç—å —ç—Ç–æ –∏ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, –µ—Å–ª–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥ –±—É–¥—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã —Ä–∞–∑–Ω—ã–µ –ø–ª–∞–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–¥–Ω–∞ –±—É–¥–µ—Ç —á–∏—Ç–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –∞ –¥—Ä—É–≥–∞—è - –ø–æ –∏–Ω–¥–µ–∫—Å—É

- [x] –ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é —ç—Ç—É —Å–∏—Ç—É–∞—Ü–∏—é —Å –ø–æ–º–æ—â—å—é –∫—É—Ä—Å–æ—Ä–æ–≤, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –¥–∞—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Ä—è–¥–∫–æ–º —á—Ç–µ–Ω–∏—è:

---
**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`silunsky_db=# begin;`

BEGIN

`silunsky_db=*# declare cur1 cursor for
select i, amount from otus
order by i for update;`

DECLARE CURSOR

`silunsky_db=*#` 

---

**[–°–ï–°–°–ò–Ø ‚Ññ2]**

`silunsky_db=# begin;`

BEGIN

`silunsky_db=*# declare cur2 cursor for
select i, amount from otus 
order by i desc for update;`

DECLARE CURSOR

silunsky_db=*# 

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`silunsky_db=*# fetch cur1;`

| i | amount |      
|---|--------|
| 2 |      0 |
(1 row)

---

**[–°–ï–°–°–ò–Ø ‚Ññ2]**

`silunsky_db=*# fetch cur2;`

| i  | amount | 
|----|--------|
| 10 |    100 |
(1 row)

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`silunsky_db=*# fetch cur1;`

| i | amount | 
|---|--------|
| 3 |    700 |
(1 row)

---

**[–°–ï–°–°–ò–Ø ‚Ññ2]**

`silunsky_db=*# fetch cur2;`

| i | amount | 
|---|--------|
| 4 |    600 |
(1 row)

---

**[–°–ï–°–°–ò–Ø ‚Ññ1]**

`silunsky_db=*# fetch cur1;`

| (–≤–∏—Å–∏—Ç)

---

**[–°–ï–°–°–ò–Ø ‚Ññ2]**

`silunsky_db=*#  SELECT pg_backend_pid();`

| pg_backend_pid | 
|----------------|
|           4836 |
(1 row)

`silunsky_db=*# SELECT * FROM locks_v WHERE pid = 4836;`

| pid  |   locktype    | lockid |     mode      | granted | 
|------|---------------|--------|---------------|---------|
| 4836 | relation      | otus   | RowShareLock  | t       |
| 4836 | transactionid | 865224 | ExclusiveLock | t       |
(2 rows)

`silunsky_db=*# fetch cur2;`

üòÉ **–ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã `fetch cur2;` –ø—Ä–æ–∏–∑–æ—à–ª–∞ –≤–∑–∞–∏–º–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞:**

ERROR:  deadlock detected

DETAIL:  Process 4836 waits for ShareLock on transaction 865223; blocked by process 4793.

Process 4793 waits for ShareLock on transaction 865224; blocked by process 4836.

HINT:  See server log for query details.

CONTEXT:  while locking tuple (0,16) in relation "otus"

silunsky_db=!# 


