# –î–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ ‚Ññ5 (–∫ –∑–∞–Ω—è—Ç–∏—é –æ—Ç 28.08.23)
[vacuum]

- [x] –ò—Å–ø–æ–ª—å–∑—É—é —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã "postgres2" —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ YC (–û–°:Ubuntu 22.04, HDD 10Gb, RAM 4Gb);
- [x] –î–æ–±–∞–≤–ª–µ–Ω ssh –∫–ª—é—á –≤ metadata –í–ú yc_key.pub;
- [x] –†–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–ª–∞—Å—Ç–µ—Ä –ë–î PostgreSQL 15;

`silunsky@postgres:~$ pg_lsclusters`

`Ver Cluster Port Status Owner    Data directory              Log file`

`15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log`

–î–ª—è —Ç–µ—Å—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω–∞—è –ë–î **silunsky** –∏ —Ç–∞–±–ª–∏—Ü–∞ **otus**

postgres@postgres2:~$ psql 

psql (15.4 (Ubuntu 15.4-1.pgdg22.04+1))

Type "help" for help.

`postgres=# \c silunsky_db `

You are now connected to database "silunsky_db" as user "postgres".

`silunsky_db=# select * from otus;`

| i | amount | 
|---|--------|
| 1 |    100 |
| 2 |    200 |
| 3 |    300 |
| 4 |    500 |
(4 rows)

- [x] –í—ã–ø–æ–ª–Ω–∏–ª –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ PostgreSQL, –≤—ã–ø–æ–ª–Ω–∏–≤ –∫–æ–º–∞–Ω–¥—É:

`postgres@postgres2:~$ pgbench -i postgres`

dropping old tables...

creating tables...

generating data (client-side)...

100000 of 100000 tuples (100%) done (elapsed 0.31 s, remaining 0.00 s)

vacuuming...

creating primary keys...

done in 2.61 s (drop tables 0.82 s, create tables 0.79 s, client-side generate 0.38 s, vacuum 0.29 s, primary keys 0.34 s).

---
- [x] –ó–∞–ø—É—Å—Ç–∏–ª –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: `pgbench -c8 -P 6 -T 60 -U postgres postgres`

–≥–¥–µ:

-c8 # –ß–∏—Å–ª–æ –∏–º–∏—Ç–∏—Ä—É–µ–º—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ç–æ –µ—Å—Ç—å —á–∏—Å–ª–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ–∞–Ω—Å–æ–≤ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö;

-P 6 # –≤—ã–≤–æ–¥–∏—Ç –æ—Ç—á—ë—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ —Å–µ–∫—É–Ω–¥ (—Å–µ–∫);

-T 60 # –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–µ—Å—Ç —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö), –∞ –Ω–µ –ø–æ —á–∏—Å–ª—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞. 

`postgres@postgres2:~$ pgbench -c8 -P 6 -T 60 -U postgres postgres`

pgbench (15.4 (Ubuntu 15.4-1.pgdg22.04+1))

starting vacuum...end.

progress: 6.0 s, 295.0 tps, lat 26.951 ms stddev 26.481, 0 failed

progress: 12.0 s, 456.5 tps, lat 17.558 ms stddev 13.438, 0 failed

progress: 18.0 s, 451.5 tps, lat 17.700 ms stddev 13.756, 0 failed

progress: 24.0 s, 391.3 tps, lat 20.413 ms stddev 15.315, 0 failed

progress: 30.0 s, 306.2 tps, lat 26.181 ms stddev 17.866, 0 failed

progress: 36.0 s, 295.5 tps, lat 27.029 ms stddev 27.815, 0 failed

progress: 42.0 s, 412.5 tps, lat 19.390 ms stddev 13.067, 0 failed

progress: 48.0 s, 414.2 tps, lat 19.348 ms stddev 12.796, 0 failed

progress: 54.0 s, 412.7 tps, lat 19.354 ms stddev 13.690, 0 failed

progress: 60.0 s, 376.3 tps, lat 21.249 ms stddev 13.746, 0 failed

transaction type: <builtin: TPC-B (sort of)>

scaling factor: 1

query mode: simple

number of clients: 8

number of threads: 1

maximum number of tries: 1

duration: 60 s

number of transactions actually processed: 22878

number of failed transactions: 0 (0.000%)

latency average = 20.985 ms

latency stddev = 17.173 ms

initial connection time = 19.783 ms

tps = 381.074861 (without initial connection time)

- [x] –ü—Ä–∏–º–µ–Ω–∏–ª –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ PostgreSQL –∏–∑ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∑–∞–Ω—è—Ç–∏—è —Ñ–∞–π–ª–∞ - —É–≤–µ–ª–∏—á–∏–≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ max_workers —Å 3 –¥–æ 5
–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª –∑–∞–Ω–æ–≤–æ. –ó–∞ —Å—á–µ—Ç —ç—Ç–æ–≥–æ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–≤—ã—Å–∏–ª–∞—Å—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

number of transactions actually processed: 23918

number of failed transactions: 0 (0.000%)

latency average = 20.068 ms

latency stddev = 16.774 ms

initial connection time = 16.870 ms

tps = 398.560178 (without initial connection time)


- [x] –°–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É **otus2** —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ–ª–µ–º –∏ –∑–∞–ø–æ–ª–Ω–∏–º —Å–ª—É—á–∞–π–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –≤ —Ä–∞–∑–º–µ—Ä–µ 1–º–ª–Ω —Å—Ç—Ä–æ–∫:

`postgres=# \c silunsky_db You are now connected to database "silunsky_db" as user "postgres".`

`silunsky_db=# `

`silunsky_db=# CREATE TABLE otus2(id serial, fio char(100));`

CREATE TABLE

`silunsky_db=# INSERT INTO otus2(fio) SELECT 'noname' FROM generate_series(1,1000000);`

INSERT 0 1000000

- [x] –ø–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π:

`silunsky_db=# SELECT pg_size_pretty(pg_total_relation_size('otus2'));`

| pg_size_pretty | 
|----------------|
| 135 MB         |
(1 row)
 
- [x] –î–∞–ª–µ–µ, 5 —Ä–∞–∑ –æ–±–Ω–æ–≤–∏–º –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏:

`silunsky_db=# update otus2 set fio = 'name';`

UPDATE 1000000

`silunsky_db=# update otus2 set fio = 'name1';`

UPDATE 1000000

`silunsky_db=# update otus2 set fio = 'name2';`

UPDATE 1000000

`silunsky_db=# update otus2 set fio = 'name3';`

UPDATE 1000000

`silunsky_db=# update otus2 set fio = 'name4';`

UPDATE 1000000

- [x] –î–∞–ª–µ–µ, –ø–æ—Å–º–æ—Ç—Ä–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ—á–µ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ **otus2** –∏ –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –ø—Ä–∏—Ö–æ–¥–∏–ª –∞–≤—Ç–æ–≤–∞–∫—É—É–º:

`silunsky_db=# SELECT relname, n_live_tup, n_dead_tup, trunc(100*n_dead_tup/(n_live_tup+1))::float "ratio%", last_autovacuum FROM pg_stat_user_TABLEs WHERE relname = 'otus2';`

| relname | n_live_tup | n_dead_tup | ratio% |        last_autovacuum        | 
|---------|------------|------------|--------|-------------------------------|
| otus2   |     997321 |    4999714 |    501 | 2023-08-29 07:14:29.603158+00 |
(1 row)

–∏–º–µ—é—Ç—Å—è 4999714 –º–µ—Ä—Ç–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π(—Ç–∞–ø–ª–æ–≤), –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –∞–≤—Ç–æ–≤–∞–∫—É—É–º –ø—Ä–∏—Ö–æ–¥–∏–ª 2023-08-29 07:14:29

- [x] –î–∞–ª–µ–µ, –≤—ã–∂–¥–∞–≤ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è, –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –ø—Ä–æ—à–µ–ª –∞–≤—Ç–æ–≤–∞–∫—É—É–º:

`silunsky_db=# SELECT relname, n_live_tup, n_dead_tup, trunc(100*n_dead_tup/(n_live_tup+1))::float "ratio%", last_autovacuum FROM pg_stat_user_TABLEs WHERE relname = 'otus2';`

| relname | n_live_tup | n_dead_tup | ratio% |       last_autovacuum        |        
|---------|------------|------------|--------|------------------------------|
| otus2   |    1661903 |          0 |      0 | 2023-08-29 07:22:23.15571+00 |
(1 row)

üôÇ –∞–≤—Ç–æ–≤–∞–∫—É—É–º –ø—Ä–æ—à–µ–ª –∏ –º–µ—Ä—Ç–≤—ã—Ö —Ç–∞–ø–ª–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç.

- [x] –î–∞–ª–µ–µ, –µ—â–µ 10 —Ä–∞–∑ –æ–±–Ω–æ–≤–∏–ª —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ **otus2** —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∏–º –µ–µ —Ä–∞–∑–º–µ—Ä:

`silunsky_db=# SELECT pg_size_pretty(pg_total_relation_size('otus2'));`

–ë–´–õ–û 135 MB, –°–¢–ê–õ–û:

| pg_size_pretty | 
|----------------|
| 808 MB         |
(1 row)

- [x] –î–∞–ª–µ–µ, –æ—Ç–∫–ª—é—á–∞—é –ê–≤—Ç–æ–≤–∞–∫—É—É–º –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ **otus2**:

`silunsky_db=# ALTER TABLE otus2 SET (autovacuum_enabled = off);`

ALTER TABLE

–ü–æ—Å–ª–µ —á–µ–≥–æ –µ—â—ë 10 —Ä–∞–∑ –æ–±–Ω–æ–≤–∏–º —Å—Ç—Ä–æ—á–∫–∏ —Ç–∞–±–ª–∏—Ü—ã **otus2** –∏ –ø–æ—Å–º–æ—Ç—Ä–∏–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π **otus2**:

`silunsky_db=# SELECT pg_size_pretty(pg_total_relation_size('otus2'));`

–ë–´–õ–û 808 MB, –°–¢–ê–õ–û:

| pg_size_pretty | 
|----------------|
| 1070 MB        |
(1 row)

`silunsky_db=# SELECT relname, n_live_tup, n_dead_tup, trunc(100*n_dead_tup/(n_live_tup+1))::float "ratio%", last_autovacuum FROM pg_stat_user_TABLEs WHERE relname = 'otus2';`

| relname | n_live_tup | n_dead_tup | ratio% |        last_autovacuum        |
|---------|------------|------------|--------|-------------------------------|
| otus2   |    1743934 |    9997795 |    573 | 2023-08-29 07:53:23.744555+00 |
(1 row)

–ü–æ—Å–ª–µ –ø—Ä–∏–∑–≤–µ–¥–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –º—ã –Ω–∞–±–ª—é–¥–∞–µ–º –ø—Ä–∏—Ä–æ—Å—Ç –º–µ—Ä—Ç–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π, –∑–∞ —Å—á–µ—Ç –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ —Ç–∞–±–ª–∏—Ü—ã.
–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è "–º—É—Å–æ—Ä–∞" –ø—Ä–∏–º–µ–Ω–∏—é –≤ —Ä—É—á–Ω–æ–º —Ä–∂–∏–º–µ `vacuum full` —Ç–µ–º —Å–∞–º—ã–º –ø—Ä–∏–≤–µ–¥—è —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Ç–∞–±–ª–∏—Ü—ã **otus2** –≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è–µ –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ—Ä–∏–∏ –¥–µ—Å—è—Ç–∫–æ–≤ –æ—Ç–µ—Ä–∞—Ü–∏–π `silunsky_db=# update otus2 set fio = 'name3';` 

`silunsky_db=# SELECT pg_relation_filepath('otus2');`


|pg_relation_filepath | 
|---------------------|
| base/16388/16441    |
(1 row)


`silunsky_db=# vacuum full otus2;`

VACUUM

`silunsky_db=# SELECT pg_relation_filepath('otus2');`

|pg_relation_filepath  |
|----------------------|
| base/16388/16445     | 
(1 row)

`silunsky_db=# SELECT pg_size_pretty(pg_total_relation_size('otus2'));`

| pg_size_pretty  | 
|---------------- |
| 135 MB          |
(1 row)





